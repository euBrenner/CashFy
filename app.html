<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashFy - Sistema</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4e54c8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashFy">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
    
    <style>
        :root { --primary: #4e54c8; --secondary: #8f94fb; --bg: #f0f2f5; --white: #ffffff; --text: #2d3436; --success: #00b894; --danger: #d63031; --warning: #fdcb6e; --info: #0984e3; --shadow: 0 10px 20px rgba(0,0,0,0.08); }
        body.dark-mode { --bg: #18191a; --white: #242526; --text: #e4e6eb; --shadow: 0 10px 20px rgba(0,0,0,0.3); }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); transition: all 0.3s; padding-bottom: 80px; }
        body.privacy-mode .blur-content { filter: blur(6px); user-select: none; pointer-events: none; transition: filter 0.3s; }
        div:where(.swal2-container) { z-index: 20000 !important; }
        
        /* LOGIN OVERLAY ATUALIZADO */
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        
        .login-box { background: var(--white); padding: 40px 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; margin-bottom: 10px; }
        .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 14px; width: 100%; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-link { background: none; border: none; color: #666; cursor: pointer; text-decoration: underline; margin-top: 10px; font-size: 14px; }
        .forgot-pass { margin-top: 15px; color: var(--primary); text-decoration: underline; cursor: pointer; font-size: 14px; display: block; font-weight: 500; }
        
        #appContainer { display: none; padding: 10px; max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand-icon { width: 50px; height: 50px; background: var(--white); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 24px; box-shadow: var(--shadow); }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .btn-icon-top { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--white); color: var(--text); font-size: 18px; cursor: pointer; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .btn-icon-top.active { background: var(--primary); color: white; }
        .user-profile { display: flex; align-items: center; gap: 10px; background: var(--white); padding: 8px 15px; border-radius: 50px; box-shadow: var(--shadow); cursor: pointer; transition: 0.2s; }
        .nav-menu { background: var(--white); padding: 10px; border-radius: 15px; display: flex; gap: 10px; box-shadow: var(--shadow); margin-bottom: 30px; overflow-x: auto; position: sticky; top: 10px; z-index: 100; }
        .nav-btn { flex: 1; border: none; background: transparent; padding: 15px; border-radius: 10px; font-family: 'Poppins'; font-weight: 600; color: #888; cursor: pointer; transition: 0.3s; white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 13px; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(78, 84, 200, 0.4); }
        .main-card { background: var(--white); border-radius: 20px; padding: 30px; box-shadow: var(--shadow); margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 8px; }
        input, select, textarea { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-family: 'Poppins'; font-size: 14px; transition: 0.3s; background: #fafafa; color: #333; }
        .status-toggle { display: flex; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 12px; border: 2px solid #eee; cursor: pointer; }
        .status-toggle input { width: 20px; height: 20px; margin-right: 10px; }
        .status-toggle span { font-weight: 600; color: #555; }
        .month-nav { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 10px 20px; border-radius: 50px; margin-bottom: 20px; border: 1px solid #eee; }
        .btn-month { background: white; border: 1px solid #ddd; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: var(--primary); transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .month-label { font-weight: 700; font-size: 16px; color: #333; text-transform: capitalize; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); padding: 25px; border-radius: 16px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .card h3 { font-size: 14px; color: #888; margin: 0; text-transform: uppercase; }
        .card p { font-size: 28px; font-weight: 700; margin: 10px 0 0 0; color: var(--text); }
        .card-sub { font-size: 12px; color: #888; margin-top: 5px; }
        .card.ent { border-bottom: 4px solid var(--success); } .card.sai { border-bottom: 4px solid var(--danger); } .card.sal { border-bottom: 4px solid var(--primary); }
        .wallet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        .wallet-card { background: var(--white); padding: 20px; border-radius: 16px; border: 1px solid #eee; position: relative; transition: 0.3s; display:flex; flex-direction:column; justify-content:space-between; min-height: 120px; }
        .wallet-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .wallet-icon { width: 40px; height: 40px; border-radius: 10px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #555; }
        .wallet-balance { font-size: 20px; font-weight: 700; color: var(--text); }
        .limit-bar-container { width: 100%; height: 6px; background: #eee; border-radius: 3px; margin-top: 10px; overflow: hidden; }
        .limit-bar-fill { height: 100%; background: var(--primary); border-radius: 3px; transition: width 0.5s ease; }
        .limit-info { display: flex; justify-content: space-between; font-size: 11px; color: #888; margin-top: 5px; }

        .charts-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: var(--white); padding: 20px; border-radius: 16px; height: auto; min-height: 350px; box-shadow: var(--shadow); display: flex; flex-direction: column; }
        .canvas-container { position: relative; flex: 1; min-height: 250px; width: 100%; }
        @media(max-width: 768px) { .charts-area { grid-template-columns: 1fr; } }
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-size: 13px; color: #888; font-weight: 600; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; color: var(--text); vertical-align: middle; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-in { background: rgba(0, 184, 148, 0.15); color: var(--success); } .badge-out { background: rgba(214, 48, 49, 0.15); color: var(--danger); } .badge-transf { background: rgba(9, 132, 227, 0.15); color: var(--info); }
        .btn-sm { padding: 8px; border-radius: 8px; border: none; cursor: pointer; transition: 0.2s; margin-right: 3px; font-size: 14px;}
        .btn-check { background: rgba(0, 184, 148, 0.1); color: var(--success); } .btn-check:hover { background: var(--success); color: white; }
        .btn-print { background: rgba(9, 132, 227, 0.1); color: var(--info); } .btn-print:hover { background: var(--info); color: white; }
        .btn-edit { background: rgba(253, 203, 110, 0.2); color: #e17055; } .btn-delete { background: rgba(214, 48, 49, 0.1); color: var(--danger); }
        .goal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .goal-card { background: var(--white); padding: 25px; border-radius: 16px; border: 1px solid #eee; box-shadow: var(--shadow); position: relative; transition: 0.3s; }
        .big-progress { height: 12px; background: #f0f0f0; border-radius: 6px; overflow: hidden; margin-bottom: 20px; }
        .big-fill { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); border-radius: 6px; transition: width 1s ease; }
        .btn-deposit { background: rgba(0, 184, 148, 0.1); color: var(--success); padding: 10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; flex:1; }
        .btn-withdraw { background: rgba(253, 203, 110, 0.2); color: #e67e22; padding: 10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; flex:1; }
        .btn-trash { width: 40px; background: transparent; color: #ccc; }
        .cat-item { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top:5px; }
        .progress-fill { height: 100%; border-radius: 4px; }
        .tab-content { display: none; animation: slideIn 0.3s ease; } .tab-content.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .backup-area { margin-top:30px; padding-top:20px; border-top:2px dashed #eee; }
        .backup-btn { background: #34495e; color:white; width:100%; margin-bottom:10px; padding:12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; }
        .backup-btn.restore { background: var(--warning); color: #d35400; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--white); width: 90%; max-width: 900px; height: 90%; border-radius: 20px; padding: 30px; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: var(--danger); }
        .welcome-card { background: #e3f2fd; border-left: 5px solid var(--info); padding: 20px; border-radius: 12px; margin-bottom: 25px; display: none; }
        .welcome-card h3 { color: var(--info); margin-top: 0; }
        .welcome-card p { color: #555; font-size: 14px; }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        
        /* ADMIN */
        .admin-area { background: #2d3436; color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: none; border: 2px solid var(--warning); }
    </style>
</head>
<body>

<div id="loginOverlay">
    <a href="index.html" style="position: absolute; top: 25px; left: 25px; color: rgba(255,255,255,0.8); text-decoration: none; font-size: 14px; font-weight: 500; display: flex; align-items: center; gap: 8px; transition: 0.3s;" onmouseover="this.style.color='white'" onmouseout="this.style.color='rgba(255,255,255,0.8)'">
        <i class="fas fa-arrow-left"></i> Voltar ao Site
    </a>

    <div class="login-box">
        <i class="fas fa-wallet" style="font-size:50px; color:var(--primary); margin-bottom:20px;"></i>
        <h2 style="color:var(--text)">CashFy</h2>
        <p style="margin-bottom:20px; color:#666;">Seu gerenciador financeiro</p>
        <input type="email" id="emailInput" placeholder="E-mail" style="margin-bottom:15px;">
        <input type="password" id="passInput" placeholder="Senha" style="margin-bottom:20px;">
        <div id="divInviteCode" style="display:none; margin-bottom:20px;">
            <label style="display:block; text-align:left; font-size:12px; color:var(--primary); font-weight:bold; margin-bottom:5px;">C√≥digo de Convite</label>
            <input type="text" id="inviteCode" placeholder="Cole seu c√≥digo aqui">
        </div>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn-primary" id="btnLogin">ENTRAR</button>
            <button class="btn-outline" id="btnRegisterMode">CRIAR CONTA</button>
            <button class="btn-primary" id="btnConfirmRegister" style="display:none;">VALIDAR & CRIAR</button>
            <button class="btn-link" id="btnBackToLogin" style="display:none;">Voltar para Login</button>
        </div>
        <a class="forgot-pass" onclick="resetarSenha()">Esqueci minha senha</a>
    </div>
</div>

<div id="modalRelatorio" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-close" onclick="fecharRelatorio()"><i class="fas fa-times-circle"></i></div>
        <h2 style="text-align:center; margin-bottom:30px;">Relat√≥rio Anual <span id="anoRelatorio"></span></h2>
        <div class="report-grid">
            <div class="card ent"><h3>Total Entradas</h3><p id="repEntradas" style="color:var(--success)">R$ 0,00</p></div>
            <div class="card sai"><h3>Total Sa√≠das</h3><p id="repSaidas" style="color:var(--danger)">R$ 0,00</p></div>
            <div class="card sal"><h3>Resultado</h3><p id="repSaldo" style="color:var(--primary)">R$ 0,00</p></div>
        </div>
        <div style="height:400px; width:100%;"><canvas id="graficoAnual"></canvas></div>
    </div>
</div>

<div id="appContainer">
    <div class="header">
        <div class="brand">
            <div class="brand-icon"><i class="fas fa-chart-pie"></i></div>
            <div><h1 style="margin:0; font-size:22px; font-weight:700;">CashFy</h1><span style="font-size:13px; color:#888;">Gest√£o 360¬∫</span></div>
        </div>
        <div class="header-actions">
            <button class="btn-icon-top" id="btnTheme" onclick="toggleTheme()" title="Modo Escuro/Claro"><i class="fas fa-moon"></i></button>
            <button class="btn-icon-top" id="btnHelp" onclick="iniciarTutorial()" title="Ajuda"><i class="fas fa-question"></i></button>
            <button class="btn-icon-top" id="btnPrivacy" onclick="togglePrivacy()" title="Ocultar valores"><i class="fas fa-eye"></i></button>
            <div class="user-profile" id="btnLogout">
                <div style="font-weight:600; color:#555; margin-right:5px;">Sair</div>
                <i class="fas fa-sign-out-alt" style="color:var(--danger)"></i>
            </div>
        </div>
    </div>

    <div class="nav-menu" id="mainMenu">
        <button class="nav-btn active" id="btn-lancar" onclick="mudarAba('lancar')"><i class="fas fa-plus-circle"></i> Novo (+)</button>
        <button class="nav-btn" id="btn-painel" onclick="mudarAba('painel')"><i class="fas fa-columns"></i> Vis√£o Geral</button>
        <button class="nav-btn" id="btn-contas" onclick="mudarAba('contas')"><i class="fas fa-wallet"></i> Carteiras</button>
        <button class="nav-btn" id="btn-metas" onclick="mudarAba('metas')"><i class="fas fa-bullseye"></i> Metas</button>
        <button class="nav-btn" id="btn-fixas" onclick="mudarAba('fixas')"><i class="fas fa-sync-alt"></i> Recorrentes</button>
        <button class="nav-btn" id="btn-config" onclick="mudarAba('config')"><i class="fas fa-cog"></i> Ajustes</button>
    </div>

    <div id="tabLancar" class="tab-content active">
        <div id="onboardingCardLancar" class="welcome-card">
            <h3>üëã Ol√°! Vamos come√ßar?</h3>
            <p>Para lan√ßar seu primeiro gasto, voc√™ precisa antes criar uma <b>Carteira</b> (onde voc√™ guarda o dinheiro, ex: Carteira, Nubank, Cofre).</p>
            <button class="btn-primary" style="margin-top:10px; width:auto;" onclick="mudarAba('contas')">Ir para Carteiras e Criar uma</button>
        </div>

        <div class="main-card" style="max-width: 700px; margin: 0 auto;">
            <h2 id="tituloFormLancar" style="text-align:center; margin-bottom:20px;">Nova Transa√ß√£o</h2>
            <div class="form-grid">
                <div class="form-group"><label>O que √©?</label><select id="tipo" onchange="verificarTipo()"><option value="saida">üî¥ Gastei (Despesa)</option><option value="entrada">üü¢ Ganhei (Receita)</option><option value="transferencia">üîÑ Transferi</option></select></div>
                <div class="form-group"><label>Descri√ß√£o</label><input type="text" id="desc" placeholder="Ex: Almo√ßo, Sal√°rio..."></div>
                <div class="form-group"><label>Valor (R$)</label><input type="number" id="valor" placeholder="0.00" step="0.01"></div>
                <div class="form-group"><label>Quando?</label><input type="date" id="data"></div>
                <div class="form-group" style="grid-column: 1 / -1;"><label class="status-toggle"><input type="checkbox" id="statusPago" checked><span><i class="fas fa-check-circle" style="color:var(--success)"></i> J√° aconteceu? (Pago/Recebido)</span></label></div>
                <div class="form-group" id="grupoCategoria"><label>Categoria</label><select id="categoriaSelect"><option>Carregando...</option></select></div>
                <div class="form-group" id="grupoContaOrigem"><label>Saiu de onde?</label><select id="pagamentoSelect"><option>Carregando...</option></select></div>
                <div class="form-group" id="grupoContaDestino" style="display:none;"><label>Foi para onde?</label><select id="contaDestinoSelect"><option>Carregando...</option></select></div>
                <div class="form-group" id="divParcelas" style="display:none;"><label style="color:var(--primary);">Parcelas</label><input type="number" id="parcelas" value="1" min="1"></div>
            </div>
            <button class="btn-primary" id="btnSalvar"><i class="fas fa-check"></i> CONFIRMAR</button>
            <button class="btn-sm" style="background:#ddd; display:none; margin-top:10px; width:100%; font-weight:bold; padding:15px;" id="btnCancelarEdicao" onclick="cancelarEdicao()">CANCELAR</button>
        </div>
    </div>

    <div id="tabPainel" class="tab-content">
        <div id="onboardingCardPainel" class="welcome-card">
            <h3>üìä Seus gr√°ficos aparecer√£o aqui!</h3>
            <p id="txtOnboardingPainel">Assim que voc√™ lan√ßar um gasto, esta tela vai se encher de informa√ß√µes.</p>
            <button id="btnOnboardingPainel" class="btn-primary" style="margin-top:10px; width:auto;" onclick="mudarAba('contas')">Criar Primeira Carteira Agora</button>
        </div>

        <div class="month-nav"><button class="btn-month" onclick="mudarMes(-1)"><i class="fas fa-chevron-left"></i></button><span class="month-label" id="labelMesAno">M√™s Atual</span><button class="btn-month" onclick="mudarMes(1)"><i class="fas fa-chevron-right"></i></button></div><button class="btn-primary" style="margin-bottom:20px; background: var(--text);" onclick="abrirRelatorioAnual()"><i class="fas fa-chart-line"></i> Ver Relat√≥rio Anual Completo</button><h4 style="margin:0 0 15px 0; color:#555;">Minhas Carteiras</h4><div id="resumoContas" class="wallet-grid blur-content"></div><div class="cards-grid"><div class="card ent"><h3>Receitas</h3><p id="totalEntradas" class="blur-content" style="color:var(--success)">R$ 0,00</p><div class="card-sub" id="pendenteEntradas"></div></div><div class="card sai"><h3>Despesas</h3><p id="totalSaidas" class="blur-content" style="color:var(--danger)">R$ 0,00</p><div class="card-sub" id="pendenteSaidas"></div></div><div class="card sal"><h3>Saldo</h3><p id="totalSaldo" class="blur-content" style="color:var(--primary)">R$ 0,00</p></div></div><div class="main-card"><h4 style="margin:0 0 15px 0; color:#555;"><i class="fas fa-filter"></i> Filtros</h4><div style="position: relative; margin-bottom: 20px;"><i class="fas fa-search" style="position: absolute; left: 20px; top: 16px; color: #999;"></i><input type="text" id="searchInput" style="padding-left: 50px; border-radius: 50px;" placeholder="Buscar..." onkeyup="aplicarFiltros()"></div><div style="display:none;"><input type="date" id="filtroDataInicio" onchange="aplicarFiltros()"><input type="date" id="filtroDataFim" onchange="aplicarFiltros()"></div><select id="filtroCategoria" onchange="aplicarFiltros()" style="width:100%"><option value="todas">Todas Categorias</option></select></div><div class="charts-area"><div class="chart-box"><h4>Or√ßamento</h4><div id="resumoCategorias" class="blur-content" style="flex:1; overflow-y:auto;"></div></div><div class="chart-box"><h4>Distribui√ß√£o</h4><div class="canvas-container blur-content"><canvas id="graficoPizza"></canvas></div></div></div><div class="main-card" style="margin-bottom:30px;"><h4>Fluxo</h4><div style="height:300px; position:relative;" class="blur-content"><canvas id="graficoBarras"></canvas></div></div><div class="main-card"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3>Extrato</h3><button class="btn-sm" style="background:var(--success); color:white;" onclick="exportarExcel()"><i class="fas fa-file-excel"></i> Excel</button></div><div class="table-container"><table><thead><tr><th>STATUS</th><th>DATA</th><th>DESCRI√á√ÉO</th><th>CATEGORIA</th><th>CONTA</th><th>VALOR</th><th>A√á√ïES</th></tr></thead><tbody id="tabelaDados"></tbody></table></div></div>
    </div>

    <div id="tabContas" class="tab-content">
        <div class="main-card">
            <h3>Gerenciar Carteiras</h3>
            <p style="font-size:12px; color:#666;">Crie aqui seus bancos, cart√£o de cr√©dito ou dinheiro vivo.</p>
            <div class="form-grid" style="align-items:end;">
                <div><label>Nome</label><input type="text" id="novaContaNome" placeholder="Ex: Nubank"></div>
                <div><label>Tipo</label><select id="novaContaTipo" onchange="verificarTipoConta()"><option value="banco">Banco</option><option value="carteira">Carteira F√≠sica</option><option value="cartao">Cart√£o de Cr√©dito</option></select></div>
            </div>
            
            <div id="camposCartao" class="form-grid" style="display:none; margin-top:10px; background:#f9f9f9; padding:15px; border-radius:10px;">
                <div><label>Limite Total (R$)</label><input type="number" id="contaLimite" placeholder="Ex: 5000"></div>
                <div><label>Dia Fechamento</label><input type="number" id="contaFechamento" placeholder="Ex: 25" max="31"></div>
                <div><label>Dia Vencimento</label><input type="number" id="contaVencimento" placeholder="Ex: 05" max="31"></div>
            </div>

            <button class="btn-primary" style="margin-top:15px;" onclick="criarConta()">Criar</button>
        </div>
        <div id="listaContasGerenciar" class="wallet-grid"></div>
    </div>

    <div id="tabMetas" class="tab-content"><div class="main-card"><h2>üéØ Metas</h2><div class="form-grid" style="align-items:end;"><div><label>Nome</label><input type="text" id="metaNome"></div><div><label>Alvo</label><input type="number" id="metaAlvo"></div><div><label>Atual</label><input type="number" id="metaAtual"></div><button class="btn-primary" onclick="criarMeta()">Criar</button></div></div><div id="listaMetas" class="goal-grid"></div></div>
    <div id="tabFixas" class="tab-content"><div class="main-card"><h3>Recorrentes</h3><div class="form-grid" style="align-items:end;"><div><label>Descri√ß√£o</label><input type="text" id="fixaDesc"></div><div><label>Valor</label><input type="number" id="fixaValor"></div><div><label>Dia</label><input type="number" id="fixaDia"></div><div><label>Categoria</label><select id="fixaCategoriaSelect"></select></div><button class="btn-primary" onclick="adicionarFixa()">+</button></div></div><div class="main-card"><button class="btn-sm" style="background:var(--info);width:100%;color:white;padding:10px;" onclick="gerarLancamentosMensais()">Gerar M√™s Atual</button><div id="listaFixasContainer"></div></div></div>
    
    <div id="tabConfig" class="tab-content">
        <div id="adminArea" class="admin-area">
            <h3 style="color:var(--warning); margin-top:0;"><i class="fas fa-user-secret"></i> Painel do Dono</h3>
            <p>Gerador de Convites VIP</p>
            <button class="btn-primary" style="background: white; color: #2d3436; font-weight:bold;" onclick="criarCodigoConvite()">üé≤ GERAR C√ìDIGO NOVO</button>
            <div id="ultimoCodigo" style="margin-top:15px; font-size:20px; font-weight:bold; color:var(--success);"></div>
        </div>

        <div class="main-card">
            <h3>Categorias</h3>
            <div class="form-grid" style="align-items:end;">
                <div><label>Nome</label><input type="text" id="novaCatNome"></div>
                <div><label>Tipo</label><select id="novaCatTipo" onchange="toggleLimitInput()"><option value="saida">üî¥ Despesa</option><option value="entrada">üü¢ Receita</option></select></div>
                <div><label id="lblLimite">Teto</label><input type="number" id="novaCatLimite"></div>
                <div style="display:flex;gap:5px;"><button class="btn-primary" id="btnSalvarCat" onclick="salvarCategoria()">Add</button><button class="btn-sm" id="btnCancelarCat" style="background:#ddd;display:none;" onclick="cancelarEdicaoCat()">X</button></div>
            </div>
            <div id="listaCategoriasConfig" style="margin-top:20px;"></div>
        </div>
        <div class="main-card"><h3>üè¢ Dados do Neg√≥cio</h3><div class="form-grid"><div><label>Nome</label><input type="text" id="confEmpresa"></div><div><label>CNPJ</label><input type="text" id="confCnpj"></div><div><label>Tel</label><input type="text" id="confTel"></div><div><label>Rodap√©</label><input type="text" id="confMsg"></div></div><button class="btn-primary" onclick="salvarDadosEmpresa()">Salvar</button></div>
        <div class="main-card backup-area" style="border-top: 2px solid var(--primary);"><h3 style="color:var(--primary);"><i class="fas fa-file-import"></i> Importar Extrato</h3><div class="form-grid"><div><label>Para qual conta?</label><select id="importContaSelect"><option>Selecione...</option></select></div><div><label>Arquivo</label><input type="file" id="fileImport"></div></div><button class="backup-btn" style="background:var(--primary);" onclick="processarImportacao()"><i class="fas fa-upload"></i> Processar Arquivo</button></div>
        <div class="main-card backup-area"><h3>Backup</h3><button class="backup-btn" onclick="exportarBackup()">Baixar Dados</button><input type="file" id="fileBackup" style="display:none;" onchange="importarBackup(this)"><button class="backup-btn restore" onclick="document.getElementById('fileBackup').click()">Restaurar</button></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, updateDoc, getDoc, setDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"; 

    // --- CONFIGURA√á√ÉO DO DONO (IMPORTANTE: MUDE O EMAIL ABAIXO) ---
    const ADMIN_EMAIL = "bjalmeida.sbube13@gmail.com"; 

    // --- 1. VARI√ÅVEIS GLOBAIS ---
    let todasTransacoes=[], listaCategorias=[], listaContas=[], listaFixas=[], chartPizza=null, chartBarras=null, chartAnual=null;
    let editandoTransacaoId=null, editandoCategoriaId=null, dataReferencia=new Date();
    let dadosEmpresa = { nome: "Minha Empresa", cnpj: "", tel: "", msg: "" };
    let currentUser = null; 
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
    let jsPDF; if (window.jspdf) { jsPDF = window.jspdf.jsPDF; }

    // --- 2. FUN√á√ïES UX ---
    window.toggleTheme = () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
        if(document.getElementById('btnTheme')) document.getElementById('btnTheme').innerHTML = document.body.classList.contains('dark-mode') ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }

    window.toggleLimitInput = () => {
        const tipo = document.getElementById('novaCatTipo').value;
        const campo = document.getElementById('novaCatLimite');
        if (tipo === 'entrada') { campo.style.display = 'none'; campo.value = 0; } 
        else { campo.style.display = 'block'; }
    }

    window.verificarTipoConta = () => {
        const tipo = document.getElementById('novaContaTipo').value;
        document.getElementById('camposCartao').style.display = (tipo === 'cartao') ? 'grid' : 'none';
    }

    window.mudarAba = (aba) => { 
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); 
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); 
        const btns = document.querySelectorAll('.nav-btn');
        if(aba==='lancar'){document.getElementById('tabLancar').classList.add('active');if(btns[0])btns[0].classList.add('active');}
        else if(aba==='painel'){document.getElementById('tabPainel').classList.add('active');if(btns[1])btns[1].classList.add('active');window.aplicarFiltros();}
        else if(aba==='contas'){document.getElementById('tabContas').classList.add('active');if(btns[2])btns[2].classList.add('active');}
        else if(aba==='metas'){document.getElementById('tabMetas').classList.add('active');if(btns[3])btns[3].classList.add('active');}
        else if(aba==='fixas'){document.getElementById('tabFixas').classList.add('active');if(btns[4])btns[4].classList.add('active');}
        else{document.getElementById('tabConfig').classList.add('active');if(btns[5])btns[5].classList.add('active');} 
    }

    // --- 3. L√ìGICA CORE ---
    window.aplicarFiltros = () => { 
        const dI=document.getElementById('filtroDataInicio').value, dF=document.getElementById('filtroDataFim').value, cF=document.getElementById('filtroCategoria').value, termo=document.getElementById('searchInput').value.toLowerCase(); 
        let f=todasTransacoes.filter(i=>{ const md=i.data>=dI&&i.data<=dF, mc=cF==='todas'||i.categoria===cF, mb=i.descricao.toLowerCase().includes(termo); return md&&mc&&mb; }); 
        window.atualizarTabela(f); window.atualizarCards(f); window.atualizarGraficos(f); window.atualizarOrcamentos(f); 
    }

    window.atualizarTabela = (d) => { const t=document.getElementById('tabelaDados'); t.innerHTML=''; d.forEach(i=>{ const estaPago = i.pago !== false; let statusIcon = estaPago ? `<button class="btn-sm btn-check" title="Pago" onclick="alternarStatus('${i.id}', true)"><i class="fas fa-check-circle"></i></button>` : `<button class="btn-sm" style="background:#eee;color:#777;" title="Pagar" onclick="alternarStatus('${i.id}', false)"><i class="far fa-clock"></i></button>`; if(i.pago) statusIcon = `<button class="btn-sm btn-check" title="Desmarcar" onclick="alternarStatus('${i.id}', true)"><i class="fas fa-check-circle"></i></button>`; let badge='',c=''; if(i.tipo==='entrada'){badge='<span class="badge badge-in">ENT</span>';c='var(--success)';} else if(i.tipo==='saida'){badge='<span class="badge badge-out">SA√ç</span>';c='var(--danger)';} else{badge='<span class="badge badge-transf">TRF</span>';c='var(--info)';} if(!estaPago) c = '#999'; let valorTexto = `R$ ${i.valor.toFixed(2)}`; if(!isFinite(i.valor)) valorTexto = "Erro"; t.innerHTML+=`<tr><td>${statusIcon}</td><td>${new Date(i.data).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</td><td><b>${i.descricao}</b><br><small style="color:var(--text-sec)">${i.categoria||i.contaDestino||''}</small></td><td>${badge}</td><td><small>${i.formaPagamento}</small></td><td class="blur-content" style="font-weight:bold;color:${c}">${valorTexto}</td><td><button class="btn-sm" style="color:var(--text)" onclick="gerarReciboPDF('${i.id}')"><i class="fas fa-print"></i></button><button class="btn-sm btn-edit" onclick="prepararEdicaoTransacao('${i.id}')"><i class="fas fa-pen"></i></button><button class="btn-sm btn-delete" onclick="deletarTransacao('${i.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }); }
    window.atualizarCards = (d) => { let e=0,s=0, pe=0, ps=0; d.forEach(i=>{ if(isFinite(i.valor)){ const estaPago = i.pago !== false; if(i.tipo==='entrada') { if(estaPago) e+=i.valor; else pe+=i.valor; } if(i.tipo==='saida') { if(estaPago) s+=i.valor; else ps+=i.valor; } }}); document.getElementById('totalEntradas').innerText=`R$ ${e.toFixed(2)}`; document.getElementById('totalSaidas').innerText=`R$ ${s.toFixed(2)}`; document.getElementById('totalSaldo').innerText=`R$ ${(e-s).toFixed(2)}`; document.getElementById('pendenteEntradas').innerText=`+ R$ ${pe.toFixed(2)} a receber`; document.getElementById('pendenteSaidas').innerText=`+ R$ ${ps.toFixed(2)} a pagar`; }
    
    window.calcularSaldosContas = () => { 
        const c=document.getElementById('resumoContas'); if(!c) return; c.innerHTML=''; 
        listaContas.forEach(conta => { 
            let saldo=0; 
            todasTransacoes.forEach(t=>{ 
                const considerar = conta.tipo === 'cartao' ? true : (t.pago !== false);
                if(considerar && isFinite(t.valor)) { 
                    if(t.tipo==='entrada'&&t.formaPagamento===conta.nome) saldo+=t.valor; 
                    if(t.tipo==='saida'&&t.formaPagamento===conta.nome) saldo-=t.valor; 
                    if(t.tipo==='transferencia'){ if(t.contaOrigem===conta.nome) saldo-=t.valor; if(t.contaDestino===conta.nome) saldo+=t.valor; } 
                } 
            }); 
            if (conta.tipo === 'cartao') {
                const limite = parseFloat(conta.limite) || 0;
                const faturaAtual = Math.abs(saldo); 
                const disponivel = limite - faturaAtual;
                const percentual = limite > 0 ? (faturaAtual / limite) * 100 : 0;
                const corBarra = percentual > 80 ? 'var(--danger)' : 'var(--primary)';
                c.innerHTML+=`<div class="wallet-card"><div class="wallet-header"><div class="wallet-icon"><i class="fas fa-credit-card"></i></div><div style="flex:1; margin-left:10px;"><div class="wallet-name">${conta.nome}</div><div style="font-size:11px; color:#888;">Fatura Atual</div></div><div class="wallet-balance blur-content" style="color:var(--danger)">R$ ${faturaAtual.toFixed(2)}</div><button class="btn-sm btn-delete" style="margin-left:10px;" onclick="deletarConta('${conta.id}')"><i class="fas fa-trash"></i></button></div><div class="limit-bar-container"><div class="limit-bar-fill" style="width:${percentual>100?100:percentual}%; background:${corBarra}"></div></div><div class="limit-info"><span>Disp: <b class="blur-content">R$ ${disponivel.toFixed(2)}</b></span><span>Lim: R$ ${limite.toFixed(2)}</span></div></div>`;
            } else {
                let icon = conta.tipo === 'banco' ? 'fa-university' : 'fa-wallet';
                c.innerHTML+=`<div class="wallet-card" style="flex-direction:row; align-items:center;"><div class="wallet-icon"><i class="fas ${icon}"></i></div><div style="flex:1; margin-left:15px;"><div class="wallet-name">${conta.nome}</div><div class="wallet-balance blur-content" style="color:${saldo>=0?'var(--text)':'var(--danger)'}">R$ ${saldo.toFixed(2)}</div></div><button class="btn-sm btn-delete" onclick="deletarConta('${conta.id}')"><i class="fas fa-trash"></i></button></div>`; 
            }
        }); 
    }

    window.atualizarLabelMes = () => {
        const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const label = document.getElementById('labelMesAno');
        if(label) label.innerText = `${nomesMeses[dataReferencia.getMonth()]} ${dataReferencia.getFullYear()}`;
        const pDia = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth(), 1);
        const uDia = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth() + 1, 0);
        const inpI = document.getElementById('filtroDataInicio');
        const inpF = document.getElementById('filtroDataFim');
        if(inpI && inpF) {
            const fmt = (d) => { let month = '' + (d.getMonth() + 1), day = '' + d.getDate(), year = d.getFullYear(); if (month.length < 2) month = '0' + month; if (day.length < 2) day = '0' + day; return [year, month, day].join('-'); }
            inpI.value = fmt(pDia); inpF.value = fmt(uDia);
            window.aplicarFiltros();
        }
    }
    
    // --- 4. FUN√á√ïES DE SUPORTE ---
    window.atualizarOrcamentos = (d) => { const c=document.getElementById('resumoCategorias'); c.innerHTML=''; const g={}; d.forEach(i=>{ if(i.tipo==='saida' && i.pago !== false && isFinite(i.valor))g[i.categoria]=(g[i.categoria]||0)+i.valor; }); listaCategorias.forEach(cat=>{ const ga=g[cat.nome]||0,l=cat.limite||0; if(l===0&&ga===0)return; let p=(l>0)?(ga/l)*100:100; c.innerHTML+=`<div style="margin-bottom:15px; font-size:13px;"><div style="display:flex;justify-content:space-between;"><span>${cat.nome}</span><span class="blur-content">${ga.toFixed(0)} / ${l.toFixed(0)}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${p>100?100:p}%; background:${ga>l?'var(--danger)':'var(--success)'};"></div></div></div>`; }); }
    window.atualizarGraficos = (d) => { const cM={}; d.filter(x=>x.tipo==='saida' && x.pago !== false && isFinite(x.valor)).forEach(x=>{ cM[x.categoria]=(cM[x.categoria]||0)+x.valor; }); if(chartPizza)chartPizza.destroy(); chartPizza=new Chart(document.getElementById('graficoPizza'),{type:'doughnut',data:{labels:Object.keys(cM),datasets:[{data:Object.values(cM),backgroundColor:['#4e54c8','#8f94fb','#00b894','#fdcb6e','#d63031']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}}); const mM={}; d.forEach(x=>{ if(x.pago===false || !isFinite(x.valor))return; const m=x.data.substring(0,7); if(!mM[m])mM[m]={e:0,s:0}; if(x.tipo==='entrada')mM[m].e+=x.valor; else if(x.tipo==='saida')mM[m].s+=x.valor; }); const l=Object.keys(mM).sort(); if(chartBarras)chartBarras.destroy(); chartBarras=new Chart(document.getElementById('graficoBarras'),{type:'bar',data:{labels:l,datasets:[{label:'Entradas',data:l.map(k=>mM[k].e),backgroundColor:'#00b894',borderRadius:5},{label:'Sa√≠das',data:l.map(k=>mM[k].s),backgroundColor:'#d63031',borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false}}); }
    window.mudarMes = (d) => { dataReferencia.setMonth(dataReferencia.getMonth() + d); window.atualizarLabelMes(); }
    window.togglePrivacy = () => { document.body.classList.toggle('privacy-mode'); localStorage.setItem('privacyMode', document.body.classList.contains('privacy-mode')); }
    window.verificarTipo = () => { const t = document.getElementById('tipo').value; document.getElementById('grupoCategoria').style.display=t==='transferencia'?'none':'block'; document.getElementById('grupoContaDestino').style.display=t==='transferencia'?'block':'none'; const lblOrigem = document.querySelector('#grupoContaOrigem label'); if(lblOrigem) lblOrigem.innerText=t==='transferencia'?'Sai de onde?':'Saiu de onde?'; const sel = document.getElementById('categoriaSelect'); if(sel) { sel.innerHTML = '<option>Selecione...</option>'; listaCategorias.forEach(c => { if(c.tipo === t || !c.tipo) sel.innerHTML += `<option value="${c.nome}">${c.nome}</option>`; }); } }
    window.resetarSenha = async () => { const { value: email } = await Swal.fire({ title: 'Recuperar Senha', input: 'email', inputLabel: 'Digite seu e-mail', showCancelButton: true }); if (email) { sendPasswordResetEmail(auth, email).then(() => Swal.fire('Sucesso', 'E-mail enviado!', 'success')).catch(err => Swal.fire('Erro', err.message, 'error')); } }
    window.checkOnboarding = () => { const semContas = listaContas.length === 0; const semTransacoes = todasTransacoes.length === 0; const cardLancar = document.getElementById('onboardingCardLancar'); if(cardLancar) cardLancar.style.display = semContas ? 'block' : 'none'; const cardPainel = document.getElementById('onboardingCardPainel'); const btnPainel = document.getElementById('btnOnboardingPainel'); const txtPainel = document.getElementById('txtOnboardingPainel'); if(cardPainel) { if (semTransacoes) { cardPainel.style.display = 'block'; if (semContas) { txtPainel.innerText = "Antes de ver os gr√°ficos, precisamos configurar sua primeira carteira."; btnPainel.innerText = "Criar Carteira"; btnPainel.onclick = () => mudarAba('contas'); } else { txtPainel.innerText = "Suas carteiras est√£o prontas! Agora registre sua primeira entrada ou sa√≠da."; btnPainel.innerText = "Fazer Lan√ßamento (+)"; btnPainel.onclick = () => mudarAba('lancar'); } } else { cardPainel.style.display = 'none'; } } }

    window.salvarCategoria=async()=>{const n=document.getElementById('novaCatNome').value,l=parseFloat(document.getElementById('novaCatLimite').value)||0,t=document.getElementById('novaCatTipo').value;if(!n)return;if(editandoCategoriaId){await updateDoc(doc(db,"categorias",editandoCategoriaId),{nome:n,limite:l,tipo:t});cancelarEdicaoCat();}else{ await addDoc(collection(db,"categorias"),{nome:n,limite:l,tipo:t, uid: currentUser.uid}); }document.getElementById('novaCatNome').value='';}
    window.criarConta=async()=>{const n=document.getElementById('novaContaNome').value,t=document.getElementById('novaContaTipo').value,l=parseFloat(document.getElementById('contaLimite').value)||0,df=parseInt(document.getElementById('contaFechamento').value)||0,dv=parseInt(document.getElementById('contaVencimento').value)||0; if(!n)return Swal.fire('Erro','Nome?','error'); await addDoc(collection(db,"contas"),{nome:n,tipo:t,limite:l,diaFechamento:df,diaVencimento:dv,uid:currentUser.uid}); Toast.fire({icon:'success',title:'Criada!'});document.getElementById('novaContaNome').value='';document.getElementById('contaLimite').value='';}
    window.criarMeta=async()=>{const n=document.getElementById('metaNome').value,a=parseFloat(document.getElementById('metaAlvo').value),at=parseFloat(document.getElementById('metaAtual').value);if(!n||!a)return Swal.fire('Erro','Dados?','error'); await addDoc(collection(db,"metas"),{nome:n,alvo:a,atual:at||0, uid: currentUser.uid}); document.getElementById('metaNome').value='';}
    window.adicionarFixa=async()=>{const d=document.getElementById('fixaDesc').value,v=parseFloat(document.getElementById('fixaValor').value),dia=parseInt(document.getElementById('fixaDia').value),cat=document.getElementById('fixaCategoriaSelect').value;if(!d||!v)return Swal.fire('Erro','Preencha','error'); await addDoc(collection(db,"despesas_fixas"),{descricao:d,valor:v,dia:dia,categoria:cat, uid: currentUser.uid}); Toast.fire({icon:'success',title:'Salvo'});}
    window.gerarLancamentosMensais=async()=>{Swal.fire({title:'Gerar?',showCancelButton:true}).then(async(r)=>{if(r.isConfirmed){const h=new Date();for(const i of listaFixas){ await addDoc(collection(db,"transacoes"),{descricao:i.descricao,valor:i.valor,tipo:'saida',categoria:i.categoria,formaPagamento:'Boleto',data:new Date(h.getFullYear(),h.getMonth(),i.dia).toISOString().split('T')[0],pago:false,uid:currentUser.uid, criadoEm:new Date(),origem:'fixa'});}Toast.fire({icon:'success',title:'Gerado (Pendentes)'});}});}
    window.exportarExcel = () => { const dI=document.getElementById('filtroDataInicio').value, dF=document.getElementById('filtroDataFim').value; const f=todasTransacoes.filter(i=>i.data>=dI&&i.data<=dF); let csv="data:text/csv;charset=utf-8,Data;Descri√ß√£o;Categoria;Tipo;Valor\n"; f.forEach(r=>{ csv+=`${new Date(r.data).toLocaleDateString('pt-BR')};${r.descricao};${r.categoria};${r.tipo};${r.valor.toString().replace('.',',')}\n`; }); const l=document.createElement("a"); l.href=encodeURI(csv); l.download="relatorio.csv"; l.click(); }
    window.abrirRelatorioAnual=()=>{document.getElementById('modalRelatorio').style.display='flex';const a=dataReferencia.getFullYear();document.getElementById('anoRelatorio').innerText=a;let m=Array(12).fill(0).map(()=>({e:0,s:0}));let te=0,ts=0;todasTransacoes.forEach(t=>{const partes=t.data.split('-');const anoT=parseInt(partes[0]);const mesT=parseInt(partes[1])-1;if(anoT===a&&t.pago!==false&&t.tipo!=='transferencia'){if(t.tipo==='entrada'){m[mesT].e+=t.valor;te+=t.valor;}if(t.tipo==='saida'){m[mesT].s+=t.valor;ts+=t.valor;}}});document.getElementById('repEntradas').innerText=`R$ ${te.toFixed(2)}`;document.getElementById('repSaidas').innerText=`R$ ${ts.toFixed(2)}`;document.getElementById('repSaldo').innerText=`R$ ${(te-ts).toFixed(2)}`;if(chartAnual)chartAnual.destroy();const cx=document.getElementById('graficoAnual').getContext('2d');chartAnual=new Chart(cx,{type:'bar',data:{labels:['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],datasets:[{label:'Entradas',data:m.map(x=>x.e),backgroundColor:'#00b894'},{label:'Sa√≠das',data:m.map(x=>x.s),backgroundColor:'#d63031'}]},options:{responsive:true,maintainAspectRatio:false}});}
    window.fecharRelatorio=()=>{document.getElementById('modalRelatorio').style.display='none';}
    window.processarImportacao=()=>{const f=document.getElementById('fileImport').files[0];const c=document.getElementById('importContaSelect').value;if(!f||c==='Selecione...')return Swal.fire('Aten√ß√£o','Selecione arquivo e conta','warning');const r=new FileReader();r.onload=async(e)=>{const l=e.target.result.split('\n');let ct=0;Swal.fire({title:'Importando...',didOpen:()=>Swal.showLoading()});for(let x of l){let ln=x.trim();if(!ln)continue;const sp=ln.includes(';')?';':',';ln=ln.replace(/"/g,'');const cols=ln.split(sp);let d,desc,v;if(cols.length>=4&&cols[0].includes('-')&&!cols[0].toLowerCase().includes('date')){d=cols[0];desc=cols[2];v=parseFloat(cols[3]);}else if(cols.length>=3&&!cols[0].toLowerCase().includes('data')){let dt=cols[0];if(dt.includes('/')){const p=dt.split('/');if(p.length===3)d=`${p[2]}-${p[1]}-${p[0]}`;}else{d=dt;}desc=cols[1];let val=cols[2];if(val.includes(',')&&!val.includes('.'))val=val.replace(',','.');v=parseFloat(val);}if(d&&desc&&!isNaN(v)&&isFinite(v)){const tp=v<0?'saida':'entrada';v=Math.abs(v);await addDoc(collection(db,"transacoes"),{descricao:desc,valor:v,tipo:tp,data:d,categoria:'Importado',formaPagamento:c,contaOrigem:c,pago:true,uid:currentUser.uid,criadoEm:new Date()});ct++;}}Swal.fire('Sucesso',`${ct} importados`,'success');};r.readAsText(f);}
    window.salvarDadosEmpresa = async () => { const d={uid: currentUser.uid, nome:document.getElementById('confEmpresa').value,cnpj:document.getElementById('confCnpj').value,tel:document.getElementById('confTel').value,msg:document.getElementById('confMsg').value}; await setDoc(doc(db,"config",`dados_${currentUser.uid}`),d); Toast.fire({icon:'success'}); dadosEmpresa=d; }
    window.exportarBackup = async () => { const b={transacoes:todasTransacoes,categorias:listaCategorias,contas:listaContas,fixas:listaFixas,metas:[]}; const q=await getDocs(query(collection(db,"metas"), where("uid", "==", currentUser.uid))); q.forEach(d=>b.metas.push({id:d.id,...d.data()})); const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(b)); const a=document.createElement('a'); a.href=s; a.download="backup.json"; document.body.appendChild(a); a.click(); a.remove(); }
    window.importarBackup = async (i) => { const f=i.files[0]; if(!f) return; const r=new FileReader(); r.onload=async(e)=>{ try{ const d=JSON.parse(e.target.result); Swal.fire({title:'Restaurar Backup?',icon:'question',showCancelButton:true}).then(async(res)=>{if(res.isConfirmed){Swal.fire({title:'Aguarde...',didOpen:()=>Swal.showLoading()});const imp=async(n,l)=>{for(const x of l){const{id,...dt}=x; dt.uid=currentUser.uid; await setDoc(doc(db,n,id),dt);}}; await imp("transacoes",d.transacoes); await imp("categorias",d.categorias); await imp("contas",d.contas); if(d.metas)await imp("metas",d.metas); Swal.fire('Sucesso','Restaurado!','success');}}); } catch(z){ Swal.fire('Erro','Arquivo inv√°lido','error'); } }; r.readAsText(f); }
    window.gerarReciboPDF = (id) => { if(!jsPDF&&window.jspdf)jsPDF=window.jspdf.jsPDF; if(!jsPDF)return; const item=todasTransacoes.find(t=>t.id===id); if(!item)return; const doc=new jsPDF(); doc.setFontSize(18); doc.text(dadosEmpresa.nome||"RECIBO",105,20,null,null,"center"); doc.setFontSize(10); doc.text(`CNPJ: ${dadosEmpresa.cnpj||''} Tel: ${dadosEmpresa.tel||''}`,105,28,null,null,"center"); doc.line(20,35,190,35); doc.setFontSize(12); doc.text(`Valor: R$ ${item.valor.toFixed(2)}`,20,50); doc.text(`Ref: ${item.descricao}`,20,60); doc.text(`Data: ${new Date(item.data).toLocaleDateString('pt-BR',{timeZone:'UTC'})}`,20,70); doc.text(dadosEmpresa.msg||"",105,140,null,null,"center"); doc.save("recibo.pdf"); }
    window.iniciarTutorial = () => { if(window.driver){const d=window.driver.js.driver; d({showProgress:true,steps:[{popover:{title:'Bem-vindo',description:'Sistema Financeiro Pro'}},{element:'#btn-lancar',popover:{title:'Lan√ßar',description:'Registre aqui.'}}]}).drive();} }
    window.alternarStatus = async (id, statusAtual) => { try { await updateDoc(doc(db, "transacoes", id), { pago: !statusAtual }); } catch(e) { console.error(e); } }

    window.prepararEdicaoCategoria=(id,n,l,t)=>{document.getElementById('novaCatNome').value=n;document.getElementById('novaCatLimite').value=l;if(t)document.getElementById('novaCatTipo').value=t;toggleLimitInput();editandoCategoriaId=id;document.getElementById('btnSalvarCat').innerHTML="Salvar";document.getElementById('btnCancelarCat').style.display='block';}
    window.cancelarEdicaoCat=()=>{editandoCategoriaId=null;document.getElementById('novaCatNome').value='';document.getElementById('btnSalvarCat').innerHTML="Add";document.getElementById('btnCancelarCat').style.display='none';}
    window.prepararEdicaoTransacao=(id)=>{const i=todasTransacoes.find(t=>t.id===id);if(!i)return;document.getElementById('desc').value=i.descricao;document.getElementById('valor').value=i.valor;document.getElementById('tipo').value=i.tipo;document.getElementById('data').value=i.data;document.getElementById('categoriaSelect').value=i.categoria;document.getElementById('pagamentoSelect').value=i.formaPagamento;document.getElementById('statusPago').checked=i.pago!==false;editandoTransacaoId=id;document.getElementById('tituloFormLancar').innerText="Editando";document.getElementById('btnSalvar').innerHTML="ATUALIZAR";document.getElementById('btnCancelarEdicao').style.display='block';mudarAba('lancar');verificarTipo();}
    window.cancelarEdicao=()=>{editandoTransacaoId=null;document.getElementById('tituloFormLancar').innerText="Nova Transa√ß√£o";document.getElementById('desc').value='';document.getElementById('valor').value='';document.getElementById('statusPago').checked=true;document.getElementById('btnSalvar').innerHTML="CONFIRMAR";document.getElementById('btnCancelarEdicao').style.display='none';}
    window.deletarCategoria=async(id)=>{Swal.fire({title:'Excluir?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(async(r)=>{if(r.isConfirmed){await deleteDoc(doc(db,"categorias",id));Toast.fire({icon:'success'});}});}
    window.deletarConta=async(id)=>{Swal.fire({title:'Excluir?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(async(r)=>{if(r.isConfirmed){await deleteDoc(doc(db,"contas",id));Toast.fire({icon:'success'});}});}
    window.deletarMeta=async(id)=>{Swal.fire({title:'Excluir?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(async(r)=>{if(r.isConfirmed){await deleteDoc(doc(db,"metas",id));Toast.fire({icon:'success'});}});}
    window.deletarFixa=async(id)=>{Swal.fire({title:'Parar?',icon:'warning',showCancelButton:true,confirmButtonColor:'#d33'}).then(async(r)=>{if(r.isConfirmed){await deleteDoc(doc(db,"despesas_fixas",id));Toast.fire({icon:'success'});}});}
    window.movimentarMeta=async(id,s,d)=>{const{value:v}=await Swal.fire({title:d?'Guardar':'Sacar',input:'number',showCancelButton:true});if(v){const n=parseFloat(v),ns=d?s+n:s-n;await updateDoc(doc(db,"metas",id),{atual:ns});}}
    window.deletarTransacao=async(id)=>{Swal.fire({title:'Apagar?',showCancelButton:true,confirmButtonColor:'#d33'}).then(async(r)=>{if(r.isConfirmed)await deleteDoc(doc(db,"transacoes",id))});}

    // --- FUN√á√ÉO DO ADMIN ---
    window.criarCodigoConvite = async () => {
        const randomCode = 'VIP-' + Math.random().toString(36).substring(2, 6).toUpperCase();
        try {
            await setDoc(doc(db, "convites", randomCode), { usado: false });
            document.getElementById('ultimoCodigo').innerText = randomCode;
            navigator.clipboard.writeText(randomCode);
            Swal.fire('Sucesso!', `C√≥digo <b>${randomCode}</b> criado e copiado!`, 'success');
        } catch (error) {
            Swal.fire('Erro', 'N√£o foi poss√≠vel criar o c√≥digo. Verifique as regras do banco.', 'error');
        }
    }

    document.getElementById('btnSalvar').addEventListener('click', async()=>{
        const desc=document.getElementById('desc').value, valor=parseFloat(document.getElementById('valor').value), tipo=document.getElementById('tipo').value;
        let dataStr=document.getElementById('data').value, cat=document.getElementById('categoriaSelect').value, conta=document.getElementById('pagamentoSelect').value, pago=document.getElementById('statusPago').checked;
        let cDest=null, parc=1; if(tipo==='transferencia') cDest=document.getElementById('contaDestinoSelect').value; else parc=parseInt(document.getElementById('parcelas').value)||1;
        if(!desc||!valor||!dataStr||!conta) return Swal.fire('Aten√ß√£o','Preencha tudo','warning');
        
        try{
            if(tipo === 'saida' && !editandoTransacaoId) {
                const contaObj = listaContas.find(c => c.nome === conta);
                if(contaObj && contaObj.tipo === 'cartao' && contaObj.diaFechamento > 0) {
                    const diaCompra = parseInt(dataStr.split('-')[2]); 
                    if(diaCompra >= contaObj.diaFechamento) {
                        const confirm = await Swal.fire({ title: 'Fatura Fechada! üîí', text: `Seu cart√£o fecha dia ${contaObj.diaFechamento}. Deseja jogar essa compra para a pr√≥xima fatura?`, icon: 'question', showCancelButton: true, confirmButtonColor: '#4e54c8', cancelButtonColor: '#d33', confirmButtonText: 'Sim, pr√≥xima fatura', cancelButtonText: 'N√£o, nesta mesma' });
                        if(confirm.isConfirmed) { const d = new Date(dataStr); d.setMonth(d.getMonth() + 1); d.setDate(1); dataStr = d.toISOString().split('T')[0]; Toast.fire({icon: 'info', title: 'Data ajustada para o m√™s seguinte'}); }
                    }
                }
            }
            if(editandoTransacaoId){ await updateDoc(doc(db,"transacoes",editandoTransacaoId),{descricao:desc,valor,tipo,data:dataStr,categoria:cat,formaPagamento:conta,contaOrigem:conta,contaDestino:cDest, pago:pago}); Toast.fire({icon:'success',title:'Atualizado'}); cancelarEdicao(); } 
            else{ 
                if(tipo==='transferencia'){ await addDoc(collection(db,"transacoes"),{descricao:desc,valor,tipo,data:dataStr,contaOrigem:conta,contaDestino:cDest,formaPagamento:conta,pago:true,uid:currentUser.uid, criadoEm:new Date()}); Toast.fire({icon:'success',title:'Transf OK'}); } 
                else{ 
                    const co=listaContas.find(c=>c.nome===conta); const cc=co&&co.tipo==='cartao'; 
                    if(cc&&parc>1){ let d=new Date(dataStr); for(let i=0;i<parc;i++){ let nd=new Date(d); nd.setMonth(d.getMonth()+i); await addDoc(collection(db,"transacoes"),{descricao:`${desc} (${i+1}/${parc})`,valor,tipo,data:nd.toISOString().split('T')[0],categoria:cat,formaPagamento:conta,pago:false,uid:currentUser.uid, criadoEm:new Date()}); } Toast.fire({icon:'success',title:`${parc}x (Pendentes)`}); } 
                    else{ await addDoc(collection(db,"transacoes"),{descricao:desc,valor,tipo,data:dataStr,categoria:cat,formaPagamento:conta,pago:pago,uid:currentUser.uid, criadoEm:new Date()}); Toast.fire({icon:'success',title:'Salvo'}); } 
                } 
            } 
            document.getElementById('desc').value=''; document.getElementById('valor').value=''; 
        }catch(e){Swal.fire('Erro',e.message,'error');} 
    });

    const inicializarSistema = () => {
        onSnapshot(query(collection(db, "transacoes"), where("uid", "==", currentUser.uid), orderBy("data", "desc")), (s)=>{
            todasTransacoes = []; s.forEach(d=>todasTransacoes.push({id:d.id, ...d.data()}));
            window.aplicarFiltros(); window.calcularSaldosContas(); window.checkOnboarding();
        });
        onSnapshot(query(collection(db, "categorias"), where("uid", "==", currentUser.uid)), (s)=>{
            listaCategorias=[]; s.forEach(d=>listaCategorias.push({id:d.id,...d.data()}));
            const sel = document.getElementById('categoriaSelect');
            if(sel) { sel.innerHTML = '<option>Selecione...</option>'; listaCategorias.forEach(c => { sel.innerHTML += `<option value="${c.nome}">${c.nome}</option>`; }); }
            const selF = document.getElementById('filtroCategoria');
            if(selF) { selF.innerHTML = '<option value="todas">Todas Categorias</option>'; listaCategorias.forEach(c => { selF.innerHTML += `<option value="${c.nome}">${c.nome}</option>`; }); }
            const selFix = document.getElementById('fixaCategoriaSelect');
            if(selFix) { selFix.innerHTML = ''; listaCategorias.forEach(c => { selFix.innerHTML += `<option value="${c.nome}">${c.nome}</option>`; }); }
            const d = document.getElementById('listaCategoriasConfig');
            if(d) { d.innerHTML=''; listaCategorias.forEach(c=>{ d.innerHTML+=`<div class="cat-item"> <div style="flex:1; font-weight:600; color:${c.tipo==='entrada'?'var(--success)':'var(--danger)'}">${c.tipo==='entrada'?'üü¢':'üî¥'} ${c.nome}</div> <div style="color:#888; font-size:12px; margin-right:10px;">${c.limite>0?'Teto: R$'+c.limite:''}</div> <button class="btn-sm btn-edit" onclick="prepararEdicaoCategoria('${c.id}','${c.nome}','${c.limite}','${c.tipo}')"><i class="fas fa-pen"></i></button> <button class="btn-sm btn-delete" onclick="deletarCategoria('${c.id}')"><i class="fas fa-trash"></i></button> </div>`; }); }
            window.aplicarFiltros();
        });
        onSnapshot(query(collection(db, "contas"), where("uid", "==", currentUser.uid)), (s)=>{
            listaContas=[]; s.forEach(d=>listaContas.push({id:d.id,...d.data()}));
            const p = document.getElementById('pagamentoSelect');
            if(p) { p.innerHTML = '<option>Selecione...</option>'; listaContas.forEach(c => { p.innerHTML += `<option value="${c.nome}">${c.nome}</option>`; }); }
            const d = document.getElementById('contaDestinoSelect');
            if(d) { d.innerHTML = '<option>Selecione...</option>'; listaContas.forEach(c => { d.innerHTML += `<option value="${c.nome}">${c.nome}</option>`; }); }
            const imp = document.getElementById('importContaSelect');
            if(imp) { imp.innerHTML = '<option>Selecione...</option>'; listaContas.forEach(c => { imp.innerHTML += `<option value="${c.nome}">${c.nome}</option>`; }); }
            const l = document.getElementById('listaContasGerenciar');
            if(l) { l.innerHTML=''; listaContas.forEach(c=>{ l.innerHTML+=`<div class="wallet-card"><div class="wallet-header"><div class="wallet-icon"><i class="fas ${c.tipo==='banco'?'fa-university':(c.tipo==='cartao'?'fa-credit-card':'fa-wallet')}"></i></div><div style="flex:1; margin-left:10px;"><div class="wallet-name">${c.nome}</div><div style="font-size:11px; color:#888;">${c.tipo.toUpperCase()}</div></div><button class="btn-sm btn-delete" onclick="deletarConta('${c.id}')"><i class="fas fa-trash"></i></button></div>${c.tipo==='cartao'?`<div style="font-size:11px; color:#666; margin-top:5px;">Fechamento dia: <b>${c.diaFechamento||'-'}</b> / Vencimento: <b>${c.diaVencimento||'-'}</b><br>Limite: R$ ${c.limite||0}</div>`:''}</div>`; }); }
            window.calcularSaldosContas(); window.checkOnboarding();
        });
        onSnapshot(query(collection(db, "metas"), where("uid", "==", currentUser.uid)), (s)=>{
            const div = document.getElementById('listaMetas'); div.innerHTML=''; 
            s.forEach(d=>{ const m={id:d.id,...d.data()}; const p=(m.atual/m.alvo)*100; div.innerHTML+=`<div class="goal-card"><div style="display:flex; justify-content:space-between;"><h4>${m.nome}</h4><button class="btn-trash" onclick="deletarMeta('${m.id}')"><i class="fas fa-trash"></i></button></div><div class="big-progress"><div class="big-fill" style="width:${p>100?100:p}%"></div></div><div style="display:flex; justify-content:space-between; margin-bottom:15px;"><span class="blur-content">R$ ${m.atual}</span><span>Alvo: R$ ${m.alvo}</span></div><div style="display:flex; gap:10px;"><button class="btn-deposit" onclick="movimentarMeta('${m.id}',${m.atual},true)">Guardar</button><button class="btn-withdraw" onclick="movimentarMeta('${m.id}',${m.atual},false)">Sacar</button></div></div>`; });
        });
        onSnapshot(query(collection(db, "despesas_fixas"), where("uid", "==", currentUser.uid)), (s)=>{
            listaFixas=[]; s.forEach(d=>listaFixas.push({id:d.id,...d.data()}));
            const c=document.getElementById('listaFixasContainer'); if(c){ c.innerHTML=''; listaFixas.forEach(f=>{ c.innerHTML+=`<div class="cat-item" style="justify-content:space-between;"><div><b>${f.descricao}</b><br><small>Dia ${f.dia} - R$ ${f.valor}</small></div><button class="btn-sm btn-delete" onclick="deletarFixa('${f.id}')"><i class="fas fa-trash"></i></button></div>`; }); }
        });
        getDoc(doc(db, "config", `dados_${currentUser.uid}`)).then(d=>{ if(d.exists()) { dadosEmpresa=d.data(); document.getElementById('confEmpresa').value=dadosEmpresa.nome||''; document.getElementById('confCnpj').value=dadosEmpresa.cnpj||''; document.getElementById('confTel').value=dadosEmpresa.tel||''; document.getElementById('confMsg').value=dadosEmpresa.msg||''; } });
        window.atualizarLabelMes();
    }

    // --- SETUP DE LOGIN ---
    document.getElementById('btnLogin').addEventListener('click', () => {
        const e = document.getElementById('emailInput').value;
        const p = document.getElementById('passInput').value;
        signInWithEmailAndPassword(auth, e, p).catch(err => Swal.fire('Erro', err.message, 'error'));
    });

    document.getElementById('btnRegisterMode').addEventListener('click', () => {
        document.getElementById('btnLogin').style.display='none';
        document.getElementById('btnRegisterMode').style.display='none';
        document.getElementById('divInviteCode').style.display='block';
        document.getElementById('btnConfirmRegister').style.display='block';
        document.getElementById('btnBackToLogin').style.display='block';
    });

    document.getElementById('btnBackToLogin').addEventListener('click', () => {
        document.getElementById('btnLogin').style.display='block';
        document.getElementById('btnRegisterMode').style.display='block';
        document.getElementById('divInviteCode').style.display='none';
        document.getElementById('btnConfirmRegister').style.display='none';
        document.getElementById('btnBackToLogin').style.display='none';
    });

    document.getElementById('btnConfirmRegister').addEventListener('click', async () => {
        const e = document.getElementById('emailInput').value;
        const p = document.getElementById('passInput').value;
        const code = document.getElementById('inviteCode').value.trim();

        if(!code) return Swal.fire('Erro', 'Precisa do c√≥digo de convite!', 'error');

        // VALIDA√á√ÉO DO C√ìDIGO
        try {
            const docRef = doc(db, "convites", code);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists() && docSnap.data().usado === false) {
                // C√≥digo v√°lido! Cria a conta
                createUserWithEmailAndPassword(auth, e, p).then(async () => {
                    // Queima o c√≥digo (marca como usado)
                    await updateDoc(docRef, { usado: true, usadoPor: e, dataUso: new Date() });
                    Swal.fire('Bem-vindo!', 'Conta criada com sucesso!', 'success');
                }).catch(err => Swal.fire('Erro', err.message, 'error'));
            } else {
                Swal.fire('Erro', 'C√≥digo inv√°lido ou j√° usado!', 'error');
            }
        } catch (error) {
            Swal.fire('Erro', 'Falha ao verificar c√≥digo.', 'error');
        }
    });

    // --- LOGOUT CORRIGIDO ---
    document.getElementById('btnLogout').addEventListener('click', () => {
        signOut(auth).then(() => {
            location.reload(); 
        }).catch((error) => {
            console.error("Erro ao sair", error);
        });
    });

    // -----------------------------------------------------------
    // [IMPORTANTE] COLE SUAS CHAVES AQUI:
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyBTIRSVQ1UabzmSnAlf61YPhTCYv9YHE-o",
        authDomain: "controle-financeiro-9a038.firebaseapp.com",
        projectId: "controle-financeiro-9a038",
        storageBucket: "controle-financeiro-9a038.firebasestorage.app",
        messagingSenderId: "762240022116",
        appId: "1:762240022116:web:ac45f5b5adde61eccad171"
    };
    // -----------------------------------------------------------

    const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

    // --- CONTROLE DE EXIBI√á√ÉO DO ADMIN ---
    onAuthStateChanged(auth, (u) => { 
        if(u){ 
            currentUser = u; 
            document.getElementById('loginOverlay').style.display='none'; 
            document.getElementById('appContainer').style.display='block'; 
            
            // VERIFICA SE √â O DONO
            if (u.email === ADMIN_EMAIL) {
                const adminDiv = document.getElementById('adminArea');
                if (adminDiv) adminDiv.style.display = 'block';
            }

            inicializarSistema(); 
        } 
        else { currentUser = null; document.getElementById('loginOverlay').style.display='flex'; document.getElementById('appContainer').style.display='none'; if(document.getElementById('btnBackToLogin')) document.getElementById('btnBackToLogin').click(); } 
    });

</script>
</body>
</html>