<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CashFy - Gest√£o Financeira</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#4e54c8">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="CashFy">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="icon" type="image/png" href="icon.png">

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>
    
    <style>
        /* --- ESTILOS --- */
        :root { --primary: #4e54c8; --secondary: #8f94fb; --bg: #f0f2f5; --white: #ffffff; --text: #2d3436; --success: #00b894; --danger: #d63031; --warning: #fdcb6e; --info: #0984e3; --shadow: 0 10px 20px rgba(0,0,0,0.08); }
        body.dark-mode { --bg: #18191a; --white: #242526; --text: #e4e6eb; --shadow: 0 10px 20px rgba(0,0,0,0.3); }
        * { box-sizing: border-box; outline: none; }
        body { font-family: 'Poppins', sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--text); transition: all 0.3s; padding-bottom: 80px; }
        body.privacy-mode .blur-content { filter: blur(6px); user-select: none; pointer-events: none; transition: filter 0.3s; }
        div:where(.swal2-container) { z-index: 20000 !important; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary), var(--secondary)); z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-box { background: var(--white); padding: 40px 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .btn-primary { background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white; border: none; padding: 16px; width: 100%; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; margin-bottom: 10px; }
        .btn-outline { background: transparent; color: var(--primary); border: 2px solid var(--primary); padding: 14px; width: 100%; border-radius: 12px; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-outline:hover { background: rgba(78, 84, 200, 0.1); }
        .btn-link { background: none; border: none; color: #666; cursor: pointer; text-decoration: underline; margin-top: 10px; font-size: 14px; }
        .forgot-pass { margin-top: 15px; color: var(--primary); text-decoration: underline; cursor: pointer; font-size: 14px; display: block; font-weight: 500; }
        #appContainer { display: none; padding: 10px; max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .brand { display: flex; align-items: center; gap: 15px; }
        .brand-icon { width: 50px; height: 50px; background: var(--white); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 24px; box-shadow: var(--shadow); }
        .header-actions { display: flex; align-items: center; gap: 10px; }
        .btn-icon-top { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--white); color: var(--text); font-size: 18px; cursor: pointer; box-shadow: var(--shadow); display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .btn-icon-top.active { background: var(--primary); color: white; }
        .user-profile { display: flex; align-items: center; gap: 10px; background: var(--white); padding: 8px 15px; border-radius: 50px; box-shadow: var(--shadow); cursor: pointer; transition: 0.2s; }
        .nav-menu { background: var(--white); padding: 10px; border-radius: 15px; display: flex; gap: 10px; box-shadow: var(--shadow); margin-bottom: 30px; overflow-x: auto; }
        .nav-btn { flex: 1; border: none; background: transparent; padding: 15px; border-radius: 10px; font-family: 'Poppins'; font-weight: 600; color: #888; cursor: pointer; transition: 0.3s; white-space: nowrap; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 5px 15px rgba(78, 84, 200, 0.4); }
        .main-card { background: var(--white); border-radius: 20px; padding: 30px; box-shadow: var(--shadow); margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .form-group label { display: block; font-size: 13px; font-weight: 600; color: #555; margin-bottom: 8px; }
        input, select, textarea { width: 100%; padding: 14px; border: 2px solid #eee; border-radius: 12px; font-family: 'Poppins'; font-size: 14px; transition: 0.3s; background: #fafafa; color: #333; }
        .status-toggle { display: flex; align-items: center; background: #f8f9fa; padding: 10px; border-radius: 12px; border: 2px solid #eee; cursor: pointer; }
        .status-toggle input { width: 20px; height: 20px; margin-right: 10px; }
        .status-toggle span { font-weight: 600; color: #555; }
        .month-nav { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 10px 20px; border-radius: 50px; margin-bottom: 20px; border: 1px solid #eee; }
        .btn-month { background: white; border: 1px solid #ddd; width: 40px; height: 40px; border-radius: 50%; cursor: pointer; color: var(--primary); transition: 0.2s; display: flex; align-items: center; justify-content: center; }
        .month-label { font-weight: 700; font-size: 16px; color: #333; text-transform: capitalize; }
        .cards-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: var(--white); padding: 25px; border-radius: 16px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
        .card h3 { font-size: 14px; color: #888; margin: 0; text-transform: uppercase; }
        .card p { font-size: 28px; font-weight: 700; margin: 10px 0 0 0; color: var(--text); }
        .card-sub { font-size: 12px; color: #888; margin-top: 5px; }
        .card.ent { border-bottom: 4px solid var(--success); } .card.sai { border-bottom: 4px solid var(--danger); } .card.sal { border-bottom: 4px solid var(--primary); }
        .wallet-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .wallet-card { background: var(--white); padding: 20px; border-radius: 16px; border: 1px solid #eee; position: relative; transition: 0.3s; }
        .wallet-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px; }
        .wallet-icon { width: 40px; height: 40px; border-radius: 10px; background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 20px; color: #555; }
        .wallet-balance { font-size: 20px; font-weight: 700; color: var(--text); }
        .charts-area { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-box { background: var(--white); padding: 20px; border-radius: 16px; height: auto; min-height: 350px; box-shadow: var(--shadow); display: flex; flex-direction: column; }
        .canvas-container { position: relative; flex: 1; min-height: 250px; width: 100%; }
        @media(max-width: 768px) { .charts-area { grid-template-columns: 1fr; } }
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        th { background: #f8f9fa; padding: 15px; text-align: left; font-size: 13px; color: #888; font-weight: 600; white-space: nowrap; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 14px; color: var(--text); vertical-align: middle; }
        .badge { padding: 6px 12px; border-radius: 20px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-in { background: rgba(0, 184, 148, 0.15); color: var(--success); } .badge-out { background: rgba(214, 48, 49, 0.15); color: var(--danger); } .badge-transf { background: rgba(9, 132, 227, 0.15); color: var(--info); }
        .btn-sm { padding: 8px; border-radius: 8px; border: none; cursor: pointer; transition: 0.2s; margin-right: 3px; font-size: 14px;}
        .btn-check { background: rgba(0, 184, 148, 0.1); color: var(--success); } .btn-check:hover { background: var(--success); color: white; }
        .btn-print { background: rgba(9, 132, 227, 0.1); color: var(--info); } .btn-print:hover { background: var(--info); color: white; }
        .btn-edit { background: rgba(253, 203, 110, 0.2); color: #e17055; } .btn-delete { background: rgba(214, 48, 49, 0.1); color: var(--danger); }
        .goal-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .goal-card { background: var(--white); padding: 25px; border-radius: 16px; border: 1px solid #eee; box-shadow: var(--shadow); position: relative; transition: 0.3s; }
        .big-progress { height: 12px; background: #f0f0f0; border-radius: 6px; overflow: hidden; margin-bottom: 20px; }
        .big-fill { height: 100%; background: linear-gradient(90deg, var(--secondary), var(--primary)); border-radius: 6px; transition: width 1s ease; }
        .btn-deposit { background: rgba(0, 184, 148, 0.1); color: var(--success); padding: 10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; flex:1; }
        .btn-withdraw { background: rgba(253, 203, 110, 0.2); color: #e67e22; padding: 10px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; flex:1; }
        .btn-trash { width: 40px; background: transparent; color: #ccc; }
        .cat-item { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #f0f0f0; }
        .progress-bar { height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin-top:5px; }
        .progress-fill { height: 100%; border-radius: 4px; }
        .tab-content { display: none; animation: slideIn 0.3s ease; } .tab-content.active { display: block; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .backup-area { margin-top:30px; padding-top:20px; border-top:2px dashed #eee; }
        .backup-btn { background: #34495e; color:white; width:100%; margin-bottom:10px; padding:12px; border:none; border-radius:10px; font-weight:bold; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:10px; }
        .backup-btn.restore { background: var(--warning); color: #d35400; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: var(--white); width: 90%; max-width: 900px; height: 90%; border-radius: 20px; padding: 30px; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 20px; right: 20px; font-size: 24px; cursor: pointer; color: var(--danger); }
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-box">
        <i class="fas fa-wallet" style="font-size:50px; color:var(--primary); margin-bottom:20px;"></i>
        <h2 style="color:var(--text)">CashFy</h2>
        <p style="margin-bottom:20px; color:#666;">Seu gerenciador financeiro</p>
        
        <input type="email" id="emailInput" placeholder="E-mail" style="margin-bottom:15px;">
        <input type="password" id="passInput" placeholder="Senha" style="margin-bottom:20px;">
        
        <div id="divInviteCode" style="display:none; margin-bottom:20px;">
            <label style="display:block; text-align:left; font-size:12px; color:var(--primary); font-weight:bold; margin-bottom:5px;">C√≥digo de Convite</label>
            <input type="text" id="inviteCode" placeholder="Cole seu c√≥digo aqui">
        </div>

        <div style="display:flex; flex-direction:column; gap:10px;">
            <button class="btn-primary" id="btnLogin">ENTRAR</button>
            <button class="btn-outline" id="btnRegisterMode">CRIAR CONTA</button>
            <button class="btn-primary" id="btnConfirmRegister" style="display:none;">VALIDAR & CRIAR</button>
            <button class="btn-link" id="btnBackToLogin" style="display:none;">Voltar para Login</button>
        </div>
        
        <a class="forgot-pass" onclick="resetarSenha()">Esqueci minha senha</a>
    </div>
</div>

<div id="modalRelatorio" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-close" onclick="fecharRelatorio()"><i class="fas fa-times-circle"></i></div>
        <h2 style="text-align:center; margin-bottom:30px;">Relat√≥rio Anual <span id="anoRelatorio"></span></h2>
        <div class="report-grid">
            <div class="card ent"><h3>Total Entradas</h3><p id="repEntradas" style="color:var(--success)">R$ 0,00</p></div>
            <div class="card sai"><h3>Total Sa√≠das</h3><p id="repSaidas" style="color:var(--danger)">R$ 0,00</p></div>
            <div class="card sal"><h3>Resultado</h3><p id="repSaldo" style="color:var(--primary)">R$ 0,00</p></div>
        </div>
        <div style="height:400px; width:100%;"><canvas id="graficoAnual"></canvas></div>
    </div>
</div>

<div id="appContainer">
    <div class="header">
        <div class="brand">
            <div class="brand-icon"><i class="fas fa-chart-pie"></i></div>
            <div><h1 style="margin:0; font-size:22px; font-weight:700;">CashFy</h1><span style="font-size:13px; color:#888;">Gest√£o 360¬∫</span></div>
        </div>
        <div class="header-actions">
            <button class="btn-icon-top" id="btnTheme" onclick="toggleTheme()" title="Modo Escuro/Claro"><i class="fas fa-moon"></i></button>
            <button class="btn-icon-top" id="btnHelp" onclick="iniciarTutorial()" title="Ajuda"><i class="fas fa-question"></i></button>
            <button class="btn-icon-top" id="btnPrivacy" onclick="togglePrivacy()" title="Ocultar valores"><i class="fas fa-eye"></i></button>
            <div class="user-profile" id="btnLogout">
                <div style="font-weight:600; color:#555; margin-right:5px;">Sair</div>
                <i class="fas fa-sign-out-alt" style="color:var(--danger)"></i>
            </div>
        </div>
    </div>

    <div class="nav-menu" id="mainMenu">
        <button class="nav-btn active" id="btn-lancar" onclick="mudarAba('lancar')"><i class="fas fa-plus-circle"></i> Lan√ßar</button>
        <button class="nav-btn" id="btn-painel" onclick="mudarAba('painel')"><i class="fas fa-columns"></i> Dashboard</button>
        <button class="nav-btn" id="btn-contas" onclick="mudarAba('contas')"><i class="fas fa-university"></i> Contas</button>
        <button class="nav-btn" id="btn-metas" onclick="mudarAba('metas')"><i class="fas fa-bullseye"></i> Metas</button>
        <button class="nav-btn" id="btn-fixas" onclick="mudarAba('fixas')"><i class="fas fa-sync-alt"></i> Fixas</button>
        <button class="nav-btn" id="btn-config" onclick="mudarAba('config')"><i class="fas fa-cog"></i> Config</button>
    </div>

    <div id="tabLancar" class="tab-content active"><div class="main-card" style="max-width: 700px; margin: 0 auto;"><h2 id="tituloFormLancar" style="text-align:center; margin-bottom:20px;">Nova Transa√ß√£o</h2><div class="form-grid"><div class="form-group"><label>Tipo</label><select id="tipo" onchange="verificarTipo()"><option value="saida">üî¥ Sa√≠da</option><option value="entrada">üü¢ Entrada</option><option value="transferencia">üîÑ Transfer√™ncia</option></select></div><div class="form-group"><label>Descri√ß√£o</label><input type="text" id="desc" placeholder="Ex: Mensalidade Jo√£o"></div><div class="form-group"><label>Valor (R$)</label><input type="number" id="valor" placeholder="0.00" step="0.01"></div><div class="form-group"><label>Data</label><input type="date" id="data"></div><div class="form-group" style="grid-column: 1 / -1;"><label class="status-toggle"><input type="checkbox" id="statusPago" checked><span><i class="fas fa-check-circle" style="color:var(--success)"></i> J√° est√° pago/recebido?</span></label></div><div class="form-group" id="grupoCategoria"><label>Categoria</label><select id="categoriaSelect"><option>Carregando...</option></select></div><div class="form-group" id="grupoContaOrigem"><label>Sai de (Conta)</label><select id="pagamentoSelect"><option>Carregando...</option></select></div><div class="form-group" id="grupoContaDestino" style="display:none;"><label>Vai para (Destino)</label><select id="contaDestinoSelect"><option>Carregando...</option></select></div><div class="form-group" id="divParcelas" style="display:none;"><label style="color:var(--primary);">Parcelas</label><input type="number" id="parcelas" value="1" min="1"></div></div><button class="btn-primary" id="btnSalvar"><i class="fas fa-check"></i> CONFIRMAR</button><button class="btn-sm" style="background:#ddd; display:none; margin-top:10px; width:100%; font-weight:bold; padding:15px;" id="btnCancelarEdicao" onclick="cancelarEdicao()">CANCELAR</button></div></div>
    <div id="tabPainel" class="tab-content"><div class="month-nav"><button class="btn-month" onclick="mudarMes(-1)"><i class="fas fa-chevron-left"></i></button><span class="month-label" id="labelMesAno">M√™s Atual</span><button class="btn-month" onclick="mudarMes(1)"><i class="fas fa-chevron-right"></i></button></div><button class="btn-primary" style="margin-bottom:20px; background: var(--text);" onclick="abrirRelatorioAnual()"><i class="fas fa-chart-line"></i> Ver Relat√≥rio Anual Completo</button><h4 style="margin:0 0 15px 0; color:#555;">Minhas Contas</h4><div id="resumoContas" class="wallet-grid blur-content"></div><div class="cards-grid"><div class="card ent"><h3>Receitas</h3><p id="totalEntradas" class="blur-content" style="color:var(--success)">R$ 0,00</p><div class="card-sub" id="pendenteEntradas"></div></div><div class="card sai"><h3>Despesas</h3><p id="totalSaidas" class="blur-content" style="color:var(--danger)">R$ 0,00</p><div class="card-sub" id="pendenteSaidas"></div></div><div class="card sal"><h3>Saldo</h3><p id="totalSaldo" class="blur-content" style="color:var(--primary)">R$ 0,00</p></div></div><div class="main-card"><h4 style="margin:0 0 15px 0; color:#555;"><i class="fas fa-filter"></i> Filtros</h4><div style="position: relative; margin-bottom: 20px;"><i class="fas fa-search" style="position: absolute; left: 20px; top: 16px; color: #999;"></i><input type="text" id="searchInput" style="padding-left: 50px; border-radius: 50px;" placeholder="Buscar..." onkeyup="aplicarFiltros()"></div><div style="display:none;"><input type="date" id="filtroDataInicio" onchange="aplicarFiltros()"><input type="date" id="filtroDataFim" onchange="aplicarFiltros()"></div><select id="filtroCategoria" onchange="aplicarFiltros()" style="width:100%"><option value="todas">Todas Categorias</option></select></div><div class="charts-area"><div class="chart-box"><h4>Or√ßamento</h4><div id="resumoCategorias" class="blur-content" style="flex:1; overflow-y:auto;"></div></div><div class="chart-box"><h4>Distribui√ß√£o</h4><div class="canvas-container blur-content"><canvas id="graficoPizza"></canvas></div></div></div><div class="main-card" style="margin-bottom:30px;"><h4>Fluxo</h4><div style="height:300px; position:relative;" class="blur-content"><canvas id="graficoBarras"></canvas></div></div><div class="main-card"><div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;"><h3>Extrato</h3><button class="btn-sm" style="background:var(--success); color:white;" onclick="exportarExcel()"><i class="fas fa-file-excel"></i> Excel</button></div><div class="table-container"><table><thead><tr><th>STATUS</th><th>DATA</th><th>DESCRI√á√ÉO</th><th>CATEGORIA</th><th>CONTA</th><th>VALOR</th><th>A√á√ïES</th></tr></thead><tbody id="tabelaDados"></tbody></table></div></div></div>
    <div id="tabContas" class="tab-content"><div class="main-card"><h3>Gerenciar Carteiras</h3><div class="form-grid" style="align-items:end;"><div><label>Nome</label><input type="text" id="novaContaNome"></div><div><label>Tipo</label><select id="novaContaTipo"><option value="banco">Banco</option><option value="carteira">Carteira</option><option value="cartao">Cart√£o</option></select></div><button class="btn-primary" onclick="criarConta()">Criar</button></div></div><div id="listaContasGerenciar" class="wallet-grid"></div></div>
    <div id="tabMetas" class="tab-content"><div class="main-card"><h2>üéØ Metas</h2><div class="form-grid" style="align-items:end;"><div><label>Nome</label><input type="text" id="metaNome"></div><div><label>Alvo</label><input type="number" id="metaAlvo"></div><div><label>Atual</label><input type="number" id="metaAtual"></div><button class="btn-primary" onclick="criarMeta()">Criar</button></div></div><div id="listaMetas" class="goal-grid"></div></div>
    <div id="tabFixas" class="tab-content"><div class="main-card"><h3>Recorrentes</h3><div class="form-grid" style="align-items:end;"><div><label>Descri√ß√£o</label><input type="text" id="fixaDesc"></div><div><label>Valor</label><input type="number" id="fixaValor"></div><div><label>Dia</label><input type="number" id="fixaDia"></div><div><label>Categoria</label><select id="fixaCategoriaSelect"></select></div><button class="btn-primary" onclick="adicionarFixa()">+</button></div></div><div class="main-card"><button class="btn-sm" style="background:var(--info);width:100%;color:white;padding:10px;" onclick="gerarLancamentosMensais()">Gerar M√™s Atual</button><div id="listaFixasContainer"></div></div></div>
    
    <div id="tabConfig" class="tab-content">
        <div class="main-card">
            <h3>Categorias</h3>
            <div class="form-grid" style="align-items:end;">
                <div><label>Nome</label><input type="text" id="novaCatNome"></div>
                <div><label>Tipo</label><select id="novaCatTipo" onchange="toggleLimitInput()"><option value="saida">üî¥ Despesa</option><option value="entrada">üü¢ Receita</option></select></div>
                <div><label id="lblLimite">Teto</label><input type="number" id="novaCatLimite"></div>
                <div style="display:flex;gap:5px;"><button class="btn-primary" id="btnSalvarCat" onclick="salvarCategoria()">Add</button><button class="btn-sm" id="btnCancelarCat" style="background:#ddd;display:none;" onclick="cancelarEdicaoCat()">X</button></div>
            </div>
            <div id="listaCategoriasConfig" style="margin-top:20px;"></div>
        </div>
        <div class="main-card"><h3>üè¢ Dados do Neg√≥cio</h3><div class="form-grid"><div><label>Nome</label><input type="text" id="confEmpresa"></div><div><label>CNPJ</label><input type="text" id="confCnpj"></div><div><label>Tel</label><input type="text" id="confTel"></div><div><label>Rodap√©</label><input type="text" id="confMsg"></div></div><button class="btn-primary" onclick="salvarDadosEmpresa()">Salvar</button></div>
        <div class="main-card backup-area" style="border-top: 2px solid var(--primary);"><h3 style="color:var(--primary);"><i class="fas fa-file-import"></i> Importar Extrato</h3><div class="form-grid"><div><label>Para qual conta?</label><select id="importContaSelect"><option>Selecione...</option></select></div><div><label>Arquivo</label><input type="file" id="fileImport"></div></div><button class="backup-btn" style="background:var(--primary);" onclick="processarImportacao()"><i class="fas fa-upload"></i> Processar Arquivo</button></div>
        <div class="main-card backup-area"><h3>Backup</h3><button class="backup-btn" onclick="exportarBackup()">Baixar Dados</button><input type="file" id="fileBackup" style="display:none;" onchange="importarBackup(this)"><button class="backup-btn restore" onclick="document.getElementById('fileBackup').click()">Restaurar</button></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, orderBy, updateDoc, getDoc, setDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js"; 

    // --- VARI√ÅVEIS ---
    let todasTransacoes=[], listaCategorias=[], listaContas=[], listaFixas=[], chartPizza=null, chartBarras=null, chartAnual=null;
    let editandoTransacaoId=null, editandoCategoriaId=null, dataReferencia=new Date();
    let dadosEmpresa = { nome: "Minha Empresa", cnpj: "", tel: "", msg: "" };
    let currentUser = null; 
    const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000, timerProgressBar: true });
    let jsPDF; if (window.jspdf) { jsPDF = window.jspdf.jsPDF; }

    // --- FUN√á√ïES DE SEGURAN√áA (DEFINIDAS ANTES) ---
    window.toggleTheme = () => {
        document.body.classList.toggle('dark-mode');
        const isDark = document.body.classList.contains('dark-mode');
        if(document.getElementById('btnTheme')) document.getElementById('btnTheme').innerHTML = isDark ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    const savedTheme = localStorage.getItem('theme');
    if (savedTheme === 'dark') {
        document.body.classList.add('dark-mode');
        if(document.getElementById('btnTheme')) document.getElementById('btnTheme').innerHTML = '<i class="fas fa-sun"></i>';
    }

    window.toggleLimitInput = () => {
        const tipo = document.getElementById('novaCatTipo').value;
        const campoLimite = document.getElementById('novaCatLimite');
        const labelLimite = document.getElementById('lblLimite');
        if (tipo === 'entrada') {
            campoLimite.style.display = 'none';
            labelLimite.style.display = 'none';
            campoLimite.value = 0;
        } else {
            campoLimite.style.display = 'block';
            labelLimite.style.display = 'block';
        }
    }

    window.mudarAba = (aba) => { 
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); 
        document.querySelectorAll('.nav-btn').forEach(e=>e.classList.remove('active')); 
        const btns = document.querySelectorAll('.nav-btn');
        if(aba==='lancar'){document.getElementById('tabLancar').classList.add('active');if(btns[0])btns[0].classList.add('active');}
        else if(aba==='painel'){document.getElementById('tabPainel').classList.add('active');if(btns[1])btns[1].classList.add('active');window.aplicarFiltros();}
        else if(aba==='contas'){document.getElementById('tabContas').classList.add('active');if(btns[2])btns[2].classList.add('active');}
        else if(aba==='metas'){document.getElementById('tabMetas').classList.add('active');if(btns[3])btns[3].classList.add('active');}
        else if(aba==='fixas'){document.getElementById('tabFixas').classList.add('active');if(btns[4])btns[4].classList.add('active');}
        else{document.getElementById('tabConfig').classList.add('active');if(btns[5])btns[5].classList.add('active');} 
    }

    window.atualizarLabelMes = () => {
        const nomesMeses = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
        const label = document.getElementById('labelMesAno');
        if(label) label.innerText = `${nomesMeses[dataReferencia.getMonth()]} ${dataReferencia.getFullYear()}`;
        const pDia = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth(), 1);
        const uDia = new Date(dataReferencia.getFullYear(), dataReferencia.getMonth() + 1, 0);
        const inpI = document.getElementById('filtroDataInicio');
        const inpF = document.getElementById('filtroDataFim');
        if(inpI && inpF) {
            inpI.value = pDia.toISOString().split('T')[0];
            inpF.value = uDia.toISOString().split('T')[0];
            window.aplicarFiltros();
        }
    }

    window.mudarMes = (d) => { dataReferencia.setMonth(dataReferencia.getMonth() + d); window.atualizarLabelMes(); }
    window.togglePrivacy = () => { document.body.classList.toggle('privacy-mode'); localStorage.setItem('privacyMode', document.body.classList.contains('privacy-mode')); }
    window.verificarTipo = () => { 
        const t = document.getElementById('tipo').value; 
        document.getElementById('grupoCategoria').style.display=t==='transferencia'?'none':'block'; 
        document.getElementById('grupoContaDestino').style.display=t==='transferencia'?'block':'none'; 
        const lblOrigem = document.querySelector('#grupoContaOrigem label');
        if(lblOrigem) lblOrigem.innerText=t==='transferencia'?'Sai de':'Conta / Carteira';
        const sel = document.getElementById('categoriaSelect');
        if(sel) {
            sel.innerHTML = '<option>Selecione...</option>';
            listaCategorias.forEach(c => {
                if(c.tipo === t || !c.tipo) sel.innerHTML += `<option value="${c.nome}">${c.nome}</option>`;
            });
        }
    }

    window.resetarSenha = async () => {
        const { value: email } = await Swal.fire({ title: 'Recuperar Senha', input: 'email', inputLabel: 'Digite seu e-mail', showCancelButton: true });
        if (email) { sendPasswordResetEmail(auth, email).then(() => Swal.fire('Sucesso', 'E-mail enviado!', 'success')).catch(err => Swal.fire('Erro', err.message, 'error')); }
    }

    // --- FUN√á√ïES DE UPDATE (DEFINIDAS AQUI) ---
    window.aplicarFiltros = () => { 
        const dI=document.getElementById('filtroDataInicio').value, dF=document.getElementById('filtroDataFim').value, cF=document.getElementById('filtroCategoria').value, termo=document.getElementById('searchInput').value.toLowerCase(); 
        let f=todasTransacoes.filter(i=>{ const md=i.data>=dI&&i.data<=dF, mc=cF==='todas'||i.categoria===cF, mb=i.descricao.toLowerCase().includes(termo); return md&&mc&&mb; }); 
        atualizarTabela(f); atualizarCards(f); atualizarGraficos(f); atualizarOrcamentos(f); 
    }

    function atualizarTabela(d){ const t=document.getElementById('tabelaDados'); t.innerHTML=''; d.forEach(i=>{ const estaPago = i.pago !== false; let statusIcon = estaPago ? `<button class="btn-sm btn-check" title="Pago" onclick="alternarStatus('${i.id}', true)"><i class="fas fa-check-circle"></i></button>` : `<button class="btn-sm" style="background:#eee;color:#777;" title="Pagar" onclick="alternarStatus('${i.id}', false)"><i class="far fa-clock"></i></button>`; if(i.pago) statusIcon = `<button class="btn-sm btn-check" title="Desmarcar" onclick="alternarStatus('${i.id}', true)"><i class="fas fa-check-circle"></i></button>`; let badge='',c=''; if(i.tipo==='entrada'){badge='<span class="badge badge-in">ENT</span>';c='var(--success)';} else if(i.tipo==='saida'){badge='<span class="badge badge-out">SA√ç</span>';c='var(--danger)';} else{badge='<span class="badge badge-transf">TRF</span>';c='var(--info)';} if(!estaPago) c = '#999'; t.innerHTML+=`<tr><td>${statusIcon}</td><td>${new Date(i.data).toLocaleDateString('pt-BR',{timeZone:'UTC'})}</td><td><b>${i.descricao}</b><br><small style="color:var(--text-sec)">${i.categoria||i.contaDestino||''}</small></td><td>${badge}</td><td><small>${i.formaPagamento}</small></td><td class="blur-content" style="font-weight:bold;color:${c}">R$ ${i.valor.toFixed(2)}</td><td><button class="btn-sm" style="color:var(--text)" onclick="gerarReciboPDF('${i.id}')"><i class="fas fa-print"></i></button><button class="btn-sm btn-edit" onclick="prepararEdicaoTransacao('${i.id}')"><i class="fas fa-pen"></i></button><button class="btn-sm btn-delete" onclick="deletarTransacao('${i.id}')"><i class="fas fa-trash"></i></button></td></tr>`; }); }
    function atualizarCards(d){ let e=0,s=0, pe=0, ps=0; d.forEach(i=>{ const estaPago = i.pago !== false; if(i.tipo==='entrada') { if(estaPago) e+=i.valor; else pe+=i.valor; } if(i.tipo==='saida') { if(estaPago) s+=i.valor; else ps+=i.valor; } }); document.getElementById('totalEntradas').innerText=`R$ ${e.toFixed(2)}`; document.getElementById('totalSaidas').innerText=`R$ ${s.toFixed(2)}`; document.getElementById('totalSaldo').innerText=`R$ ${(e-s).toFixed(2)}`; document.getElementById('pendenteEntradas').innerText=`+ R$ ${pe.toFixed(2)} a receber`; document.getElementById('pendenteSaidas').innerText=`+ R$ ${ps.toFixed(2)} a pagar`; }
    function atualizarOrcamentos(d){ const c=document.getElementById('resumoCategorias'); c.innerHTML=''; const g={}; d.forEach(i=>{ if(i.tipo==='saida' && i.pago !== false)g[i.categoria]=(g[i.categoria]||0)+i.valor; }); listaCategorias.forEach(cat=>{ const ga=g[cat.nome]||0,l=cat.limite||0; if(l===0&&ga===0)return; let p=(l>0)?(ga/l)*100:100; c.innerHTML+=`<div style="margin-bottom:15px; font-size:13px;"><div style="display:flex;justify-content:space-between;"><span>${cat.nome}</span><span class="blur-content">${ga.toFixed(0)} / ${l.toFixed(0)}</span></div><div class="progress-bar"><div class="progress-fill" style="width:${p>100?100:p}%; background:${ga>l?'var(--danger)':'var(--success)'};"></div></div></div>`; }); }
    function atualizarGraficos(d){ const cM={}; d.filter(x=>x.tipo==='saida' && x.pago !== false).forEach(x=>{ cM[x.categoria]=(cM[x.categoria]||0)+x.valor; }); if(chartPizza)chartPizza.destroy(); chartPizza=new Chart(document.getElementById('graficoPizza'),{type:'doughnut',data:{labels:Object.keys(cM),datasets:[{data:Object.values(cM),backgroundColor:['#4e54c8','#8f94fb','#00b894','#fdcb6e','#d63031']}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right'}}}}); const mM={}; d.forEach(x=>{ if(x.pago===false)return; const m=x.data.substring(0,7); if(!mM[m])mM[m]={e:0,s:0}; if(x.tipo==='entrada')mM[m].e+=x.valor; else if(x.tipo==='saida')mM[m].s+=x.valor; }); const l=Object.keys(mM).sort(); if(chartBarras)chartBarras.destroy(); chartBarras=new Chart(document.getElementById('graficoBarras'),{type:'bar',data:{labels:l,datasets:[{label:'Entradas',data:l.map(k=>mM[k].e),backgroundColor:'#00b894',borderRadius:5},{label:'Sa√≠das',data:l.map(k=>mM[k].s),backgroundColor:'#d63031',borderRadius:5}]},options:{responsive:true,maintainAspectRatio:false}}); }
    function calcularSaldosContas() { const c=document.getElementById('resumoContas'); if(!c) return; c.innerHTML=''; listaContas.forEach(conta => { let saldo=0; todasTransacoes.forEach(t=>{ if(t.pago!==false) { if(t.tipo==='entrada'&&t.formaPagamento===conta.nome) saldo+=t.valor; if(t.tipo==='saida'&&t.formaPagamento===conta.nome) saldo-=t.valor; if(t.tipo==='transferencia'){ if(t.contaOrigem===conta.nome) saldo-=t.valor; if(t.contaDestino===conta.nome) saldo+=t.valor; } } }); c.innerHTML+=`<div class="wallet-card"><div class="wallet-header"><div class="wallet-icon"><i class="fas fa-wallet"></i></div><div class="wallet-name">${conta.nome}</div></div><div class="wallet-balance blur-content" style="color:${saldo>=0?'var(--text)':'var(--danger)'}">R$ ${saldo.toFixed(2)}</div></div>`; }); }

    // -----------------------------------------------------------
    // [IMPORTANTE] COLE SUAS CHAVES AQUI:
    // -----------------------------------------------------------
    const firebaseConfig = {
        apiKey: "AIzaSyBTIRSVQ1UabzmSnAlf61YPhTCYv9YHE-o",
        authDomain: "controle-financeiro-9a038.firebaseapp.com",
        projectId: "controle-financeiro-9a038",
        storageBucket: "controle-financeiro-9a038.firebasestorage.app",
        messagingSenderId: "762240022116",
        appId: "1:762240022116:web:ac45f5b5adde61eccad171"
    };
    // -----------------------------------------------------------

    const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);

    // --- EVENT LISTENERS ---
    const btnLogin = document.getElementById('btnLogin');
    const btnRegisterMode = document.getElementById('btnRegisterMode');
    const btnConfirmRegister = document.getElementById('btnConfirmRegister');
    const btnBackToLogin = document.getElementById('btnBackToLogin');
    const divInvite = document.getElementById('divInviteCode');

    if(btnRegisterMode) {
        btnRegisterMode.addEventListener('click', () => {
            btnLogin.style.display = 'none';
            btnRegisterMode.style.display = 'none';
            btnConfirmRegister.style.display = 'block';
            btnBackToLogin.style.display = 'block';
            divInvite.style.display = 'block';
        });
    }

    if(btnBackToLogin) {
        btnBackToLogin.addEventListener('click', () => {
            btnLogin.style.display = 'block';
            btnRegisterMode.style.display = 'block';
            btnConfirmRegister.style.display = 'none';
            btnBackToLogin.style.display = 'none';
            divInvite.style.display = 'none';
        });
    }

    if(btnLogin) {
        btnLogin.addEventListener('click', () => {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passInput').value;
            if(!email || !pass) return Swal.fire('Erro', 'Preencha tudo', 'warning');
            signInWithEmailAndPassword(auth, email, pass).catch(err => Swal.fire('Erro', 'Login inv√°lido.', 'error'));
        });
    }

    if(btnConfirmRegister) {
        btnConfirmRegister.addEventListener('click', async () => {
            const email = document.getElementById('emailInput').value;
            const pass = document.getElementById('passInput').value;
            const code = document.getElementById('inviteCode').value.trim();
            if(!email || !pass || !code) return Swal.fire('Aten√ß√£o', 'Preencha e-mail, senha e c√≥digo.', 'warning');
            if(pass.length < 6) return Swal.fire('Aten√ß√£o', 'A senha precisa ter 6 d√≠gitos.', 'warning');
            try {
                Swal.fire({title: 'Verificando...', didOpen: () => Swal.showLoading()});
                const inviteRef = doc(db, "convites", code);
                const inviteSnap = await getDoc(inviteRef);
                if (!inviteSnap.exists()) { return Swal.fire('Erro', 'C√≥digo de convite inv√°lido ou inexistente.', 'error'); }
                const dadosConvite = inviteSnap.data();
                if (dadosConvite.usado === true) { return Swal.fire('Bloqueado', 'Este c√≥digo de convite j√° foi utilizado.', 'error'); }
                const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                const user = userCredential.user;
                await updateDoc(inviteRef, { usado: true, usado_por: email, data_uso: new Date() });
                await setDoc(doc(db,"config",`dados_${user.uid}`), { uid: user.uid, nome: "Minha Empresa", cnpj: "", tel: "", msg: "" });
                Swal.fire('Sucesso!', 'Conta criada e ativada!', 'success');
            } catch (error) {
                let msg = error.message;
                if(error.code === 'auth/email-already-in-use') msg = "Este e-mail j√° tem cadastro.";
                Swal.fire('Erro', msg, 'error');
            }
        });
    }

    document.getElementById('btnLogout').addEventListener('click', () => signOut(auth));
    
    // --- ESTADO DE AUTENTICA√á√ÉO ---
    onAuthStateChanged(auth, (u) => { 
        if(u){ 
            currentUser = u; 
            document.getElementById('loginOverlay').style.display='none'; 
            document.getElementById('appContainer').style.display='block'; 
            inicializarSistema(); 
        } else { 
            currentUser = null;
            document.getElementById('loginOverlay').style.display='flex'; 
            document.getElementById('appContainer').style.display='none'; 
            if(btnBackToLogin) btnBackToLogin.click(); 
        } 
    });

    function inicializarSistema() {
        if(!currentUser) return;
        window.atualizarLabelMes();
        
        getDoc(doc(db,"config",`dados_${currentUser.uid}`)).then(s=>{if(s.exists()){dadosEmpresa=s.data();document.getElementById('confEmpresa').value=dadosEmpresa.nome;document.getElementById('confCnpj').value=dadosEmpresa.cnpj;document.getElementById('confTel').value=dadosEmpresa.tel;document.getElementById('confMsg').value=dadosEmpresa.msg;}});

        onSnapshot(query(collection(db,"categorias"), where("uid", "==", currentUser.uid), orderBy("nome")), (s)=>{ 
            listaCategorias=[]; const sl=document.getElementById('categoriaSelect'); const sf=document.getElementById('fixaCategoriaSelect'); const sfil=document.getElementById('filtroCategoria'); const lc=document.getElementById('listaCategoriasConfig'); 
            if(!editandoTransacaoId){sl.innerHTML='<option>Selecione...</option>';sf.innerHTML='<option>Selecione...</option>';} sfil.innerHTML='<option value="todas">Todas</option>'; lc.innerHTML=''; 
            s.forEach(d=>{ 
                const c=d.data(); listaCategorias.push({id:d.id,...c}); 
                if(!editandoTransacaoId){sl.innerHTML+=`<option value="${c.nome}">${c.nome}</option>`;sf.innerHTML+=`<option value="${c.nome}">${c.nome}</option>`;} sfil.innerHTML+=`<option value="${c.nome}">${c.nome}</option>`; 
                let i=c.tipo==='entrada'?'üü¢':'üî¥'; if(!c.tipo)i='‚ö™'; lc.innerHTML+=`<div class="cat-item"><div style="flex:1;">${i} <b>${c.nome}</b> <small>(${c.limite||0})</small></div><button class="btn-sm btn-edit" onclick="prepararEdicaoCategoria('${d.id}','${c.nome}','${c.limite}','${c.tipo}')">‚úèÔ∏è</button><button class="btn-sm btn-delete" onclick="deletarCategoria('${d.id}')">üóëÔ∏è</button></div>`; 
            }); 
            window.verificarTipo(); 
        });

        onSnapshot(query(collection(db,"contas"), where("uid", "==", currentUser.uid), orderBy("nome")), (s)=>{ 
            listaContas=[]; const s1=document.getElementById('pagamentoSelect'); const s2=document.getElementById('contaDestinoSelect'); const si=document.getElementById('importContaSelect'); const lg=document.getElementById('listaContasGerenciar'); 
            if(!editandoTransacaoId){s1.innerHTML='<option>Selecione...</option>';s2.innerHTML='<option>Selecione...</option>';} si.innerHTML='<option>Selecione...</option>'; lg.innerHTML=''; 
            s.forEach(d=>{ 
                const c=d.data(); listaContas.push({id:d.id,...c}); 
                if(!editandoTransacaoId){s1.innerHTML+=`<option value="${c.nome}">${c.nome}</option>`;s2.innerHTML+=`<option value="${c.nome}">${c.nome}</option>`;} si.innerHTML+=`<option value="${c.nome}">${c.nome}</option>`; 
                let i='fa-university'; if(c.tipo==='carteira')i='fa-wallet'; if(c.tipo==='cartao')i='fa-credit-card'; lg.innerHTML+=`<div class="wallet-card"><div class="wallet-header"><div class="wallet-icon"><i class="fas ${i}"></i></div><button class="btn-sm btn-delete" onclick="deletarConta('${d.id}')"><i class="fas fa-trash"></i></button></div><div class="wallet-name">${c.nome}</div></div>`; 
            }); 
            calcularSaldosContas(); 
        });
        
        onSnapshot(query(collection(db,"transacoes"), where("uid", "==", currentUser.uid), orderBy("data","desc")), (s)=>{ 
            todasTransacoes=[]; s.forEach(d=>todasTransacoes.push({id:d.id,...d.data()})); 
            if(!document.getElementById('filtroDataInicio').value) { const h=new Date(); document.getElementById('filtroDataInicio').value = new Date(h.getFullYear(), h.getMonth(), 1).toISOString().split('T')[0]; document.getElementById('filtroDataFim').value = new Date(h.getFullYear(), h.getMonth()+1, 0).toISOString().split('T')[0]; } 
            if(document.getElementById('tabPainel').classList.contains('active')) window.aplicarFiltros(); 
            calcularSaldosContas(); 
        });

        onSnapshot(query(collection(db,"despesas_fixas"), where("uid", "==", currentUser.uid), orderBy("dia")), (s)=>{ listaFixas=[]; document.getElementById('listaFixasContainer').innerHTML=''; s.forEach(d=>{ const i=d.data(); listaFixas.push({id:d.id,...i}); document.getElementById('listaFixasContainer').innerHTML+=`<div class="cat-item"><b>${i.descricao}</b> (Dia ${i.dia}) - R$ ${i.valor}<button class="btn-sm btn-delete" onclick="deletarFixa('${d.id}')" style="margin-left:auto;">üóëÔ∏è</button></div>`; }); });
        
        onSnapshot(query(collection(db,"metas"), where("uid", "==", currentUser.uid)), (s)=>{ document.getElementById('listaMetas').innerHTML=''; s.forEach(d=>{ const m=d.data(); const p=(m.atual/m.alvo)*100; document.getElementById('listaMetas').innerHTML+=`<div class="goal-card" style="margin-bottom:10px;"><div style="display:flex;justify-content:space-between;"><b>${m.nome}</b><button class="btn-sm btn-delete" style="width:auto;" onclick="deletarMeta('${d.id}')">üóëÔ∏è</button></div><div>R$ ${m.atual} / ${m.alvo}</div><div class="big-progress"><div class="big-fill" style="width:${p>100?100:p}%"></div></div><div style="display:flex;gap:5px;"><button class="btn-deposit" onclick="movimentarMeta('${d.id}',${m.atual},true)">+</button><button class="btn-withdraw" onclick="movimentarMeta('${d.id}',${m.atual},false)">-</button></div></div>`; }); });
    }

    window.salvarCategoria=async()=>{const n=document.getElementById('novaCatNome').value,l=parseFloat(document.getElementById('novaCatLimite').value)||0,t=document.getElementById('novaCatTipo').value;if(!n)return;if(editandoCategoriaId){await updateDoc(doc(db,"categorias",editandoCategoriaId),{nome:n,limite:l,tipo:t});cancelarEdicaoCat();}else{ await addDoc(collection(db,"categorias"),{nome:n,limite:l,tipo:t, uid: currentUser.uid}); }document.getElementById('novaCatNome').value='';}
    window.criarConta=async()=>{const n=document.getElementById('novaContaNome').value,t=document.getElementById('novaContaTipo').value;if(!n)return Swal.fire('Erro','Nome?','error'); await addDoc(collection(db,"contas"),{nome:n,tipo:t, uid: currentUser.uid}); Toast.fire({icon:'success',title:'Criada!'});document.getElementById('novaContaNome').value='';}
    window.criarMeta=async()=>{const n=document.getElementById('metaNome').value,a=parseFloat(document.getElementById('metaAlvo').value),at=parseFloat(document.getElementById('metaAtual').value);if(!n||!a)return Swal.fire('Erro','Dados?','error'); await addDoc(collection(db,"metas"),{nome:n,alvo:a,atual:at||0, uid: currentUser.uid}); document.getElementById('metaNome').value='';}
    window.adicionarFixa=async()=>{const d=document.getElementById('fixaDesc').value,v=parseFloat(document.getElementById('fixaValor').value),dia=parseInt(document.getElementById('fixaDia').value),cat=document.getElementById('fixaCategoriaSelect').value;if(!d||!v)return Swal.fire('Erro','Preencha','error'); await addDoc(collection(db,"despesas_fixas"),{descricao:d,valor:v,dia:dia,categoria:cat, uid: currentUser.uid}); Toast.fire({icon:'success',title:'Salvo'});}
    window.gerarLancamentosMensais=async()=>{Swal.fire({title:'Gerar?',showCancelButton:true}).then(async(r)=>{if(r.isConfirmed){const h=new Date();for(const i of listaFixas){ await addDoc(collection(db,"transacoes"),{descricao:i.descricao,valor:i.valor,tipo:'saida',categoria:i.categoria,formaPagamento:'Boleto',data:new Date(h.getFullYear(),h.getMonth(),i.dia).toISOString().split('T')[0],pago:false,uid:currentUser.uid, criadoEm:new Date(),origem:'fixa'});}Toast.fire({icon:'success',title:'Gerado (Pendentes)'});}});}
    document.getElementById('btnSalvar').addEventListener('click', async()=>{
        const desc=document.getElementById('desc').value, valor=parseFloat(document.getElementById('valor').value), tipo=document.getElementById('tipo').value, dataStr=document.getElementById('data').value, cat=document.getElementById('categoriaSelect').value, conta=document.getElementById('pagamentoSelect').value, pago=document.getElementById('statusPago').checked;
        let cDest=null, parc=1; if(tipo==='transferencia') cDest=document.getElementById('contaDestinoSelect').value; else parc=parseInt(document.getElementById('parcelas').value)||1;
        if(!desc||!valor||!dataStr||!conta) return Swal.fire('Aten√ß√£o','Preencha tudo','warning');
        try{ if(editandoTransacaoId){ await updateDoc(doc(db,"transacoes",editandoTransacaoId),{descricao:desc,valor,tipo,data:dataStr,categoria:cat,formaPagamento:conta,contaOrigem:conta,contaDestino:cDest, pago:pago}); Toast.fire({icon:'success',title:'Atualizado'}); cancelarEdicao(); } else{ if(tipo==='transferencia'){ await addDoc(collection(db,"transacoes"),{descricao:desc,valor,tipo,data:dataStr,contaOrigem:conta,contaDestino:cDest,formaPagamento:conta,pago:true,uid:currentUser.uid, criadoEm:new Date()}); Toast.fire({icon:'success',title:'Transf OK'}); } else{ const co=listaContas.find(c=>c.nome===conta); const cc=co&&co.tipo==='cartao'; if(cc&&parc>1){ let d=new Date(dataStr); for(let i=0;i<parc;i++){ let nd=new Date(d); nd.setMonth(d.getMonth()+i); await addDoc(collection(db,"transacoes"),{descricao:`${desc} (${i+1}/${parc})`,valor,tipo,data:nd.toISOString().split('T')[0],categoria:cat,formaPagamento:conta,pago:false,uid:currentUser.uid, criadoEm:new Date()}); } Toast.fire({icon:'success',title:`${parc}x (Pendentes)`}); } else{ await addDoc(collection(db,"transacoes"),{descricao:desc,valor,tipo,data:dataStr,categoria:cat,formaPagamento:conta,pago:pago,uid:currentUser.uid, criadoEm:new Date()}); Toast.fire({icon:'success',title:'Salvo'}); } } document.getElementById('desc').value=''; document.getElementById('valor').value=''; } }catch(e){Swal.fire('Erro',e.message,'error');} });
    window.prepararEdicaoTransacao=(id)=>{const i=todasTransacoes.find(t=>t.id===id);if(!i)return;document.getElementById('desc').value=i.descricao;document.getElementById('valor').value=i.valor;document.getElementById('tipo').value=i.tipo;document.getElementById('data').value=i.data;document.getElementById('categoriaSelect').value=i.categoria;document.getElementById('pagamentoSelect').value=i.formaPagamento;document.getElementById('statusPago').checked=i.pago!==false;editandoTransacaoId=id;document.getElementById('tituloFormLancar').innerText="Editando";document.getElementById('btnSalvar').innerHTML="ATUALIZAR";document.getElementById('btnCancelarEdicao').style.display='block';mudarAba('lancar');verificarTipo();}
    window.cancelarEdicao=()=>{editandoTransacaoId=null;document.getElementById('tituloFormLancar').innerText="Nova";document.getElementById('desc').value='';document.getElementById('valor').value='';document.getElementById('statusPago').checked=true;document.getElementById('btnSalvar').innerHTML="CONFIRMAR";document.getElementById('btnCancelarEdicao').style.display='none';}
    window.deletarCategoria=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"categorias",id));}
    window.deletarConta=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"contas",id));}
    window.deletarMeta=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"metas",id));}
    window.deletarFixa=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"despesas_fixas",id));}
    window.deletarTransacao=async(id)=>{Swal.fire({title:'Apagar?',showCancelButton:true,confirmButtonColor:'#d33'}).then(async(r)=>{if(r.isConfirmed)await deleteDoc(doc(db,"transacoes",id))});}
    window.exportarExcel = () => { const dI=document.getElementById('filtroDataInicio').value, dF=document.getElementById('filtroDataFim').value; const f=todasTransacoes.filter(i=>i.data>=dI&&i.data<=dF); let csv="data:text/csv;charset=utf-8,Data;Descri√ß√£o;Categoria;Tipo;Valor\n"; f.forEach(r=>{ csv+=`${new Date(r.data).toLocaleDateString('pt-BR')};${r.descricao};${r.categoria};${r.tipo};${r.valor.toString().replace('.',',')}\n`; }); const l=document.createElement("a"); l.href=encodeURI(csv); l.download="relatorio.csv"; l.click(); }
    window.abrirRelatorioAnual=()=>{document.getElementById('modalRelatorio').style.display='flex';const a=dataReferencia.getFullYear();document.getElementById('anoRelatorio').innerText=a;let m=Array(12).fill(0).map(()=>({e:0,s:0}));let te=0,ts=0;todasTransacoes.forEach(t=>{const d=new Date(t.data);if(d.getFullYear()===a&&t.pago!==false&&t.tipo!=='transferencia'){const x=d.getMonth();if(t.tipo==='entrada'){m[x].e+=t.valor;te+=t.valor;}if(t.tipo==='saida'){m[x].s+=t.valor;ts+=t.valor;}}});document.getElementById('repEntradas').innerText=`R$ ${te.toFixed(2)}`;document.getElementById('repSaidas').innerText=`R$ ${ts.toFixed(2)}`;document.getElementById('repSaldo').innerText=`R$ ${(te-ts).toFixed(2)}`;if(chartAnual)chartAnual.destroy();const cx=document.getElementById('graficoAnual').getContext('2d');chartAnual=new Chart(cx,{type:'bar',data:{labels:['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'],datasets:[{label:'Entradas',data:m.map(x=>x.e),backgroundColor:'#00b894'},{label:'Sa√≠das',data:m.map(x=>x.s),backgroundColor:'#d63031'}]},options:{responsive:true,maintainAspectRatio:false}});}
    window.fecharRelatorio=()=>{document.getElementById('modalRelatorio').style.display='none';}
    window.processarImportacao=()=>{const f=document.getElementById('fileImport').files[0];const c=document.getElementById('importContaSelect').value;if(!f||c==='Selecione...')return Swal.fire('Erro','Selecione','error');const r=new FileReader();r.onload=async(e)=>{const l=e.target.result.split('\n');let ct=0;for(let x of l){const cols=x.split(',');if(cols.length>=3){const d=cols[0].trim();const desc=cols[1].trim();let v=parseFloat(cols[2].trim());if(!isNaN(v)&&desc&&d.length===10){const tp=v<0?'saida':'entrada';v=Math.abs(v);await addDoc(collection(db,"transacoes"),{descricao:desc,valor:v,tipo:tp,data:d,categoria:'A Classificar',formaPagamento:c,contaOrigem:c,pago:true,uid:currentUser.uid,criadoEm:new Date()});ct++;}}}Swal.fire('Ok',`${ct} importados`,'success');};r.readAsText(f);}
    window.salvarDadosEmpresa = async () => { const d={uid: currentUser.uid, nome:document.getElementById('confEmpresa').value,cnpj:document.getElementById('confCnpj').value,tel:document.getElementById('confTel').value,msg:document.getElementById('confMsg').value}; await setDoc(doc(db,"config",`dados_${currentUser.uid}`),d); Toast.fire({icon:'success'}); dadosEmpresa=d; }
    window.exportarBackup = async () => { const b={transacoes:todasTransacoes,categorias:listaCategorias,contas:listaContas,fixas:listaFixas,metas:[]}; const q=await getDocs(query(collection(db,"metas"), where("uid", "==", currentUser.uid))); q.forEach(d=>b.metas.push({id:d.id,...d.data()})); const s="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(b)); const a=document.createElement('a'); a.href=s; a.download="backup.json"; document.body.appendChild(a); a.click(); a.remove(); }
    window.importarBackup = async (i) => { const f=i.files[0]; if(!f)return; const r=new FileReader(); r.onload=async(e)=>{ try{ const d=JSON.parse(e.target.result); if(!confirm(`Restaurar?`))return; const imp=async(n,l)=>{for(const x of l){const{id,...dt}=x; dt.uid = currentUser.uid; await setDoc(doc(db,n,id),dt);}}; await imp("transacoes",d.transacoes); await imp("categorias",d.categorias); await imp("contas",d.contas); if(d.metas)await imp("metas",d.metas); Swal.fire('Ok','Feito','success'); }catch(z){Swal.fire('Erro','Inv√°lido','error');} }; r.readAsText(f); }
    window.gerarReciboPDF = (id) => { if(!jsPDF&&window.jspdf)jsPDF=window.jspdf.jsPDF; if(!jsPDF)return; const item=todasTransacoes.find(t=>t.id===id); if(!item)return; const doc=new jsPDF(); doc.setFontSize(18); doc.text(dadosEmpresa.nome||"RECIBO",105,20,null,null,"center"); doc.setFontSize(10); doc.text(`CNPJ: ${dadosEmpresa.cnpj||''} Tel: ${dadosEmpresa.tel||''}`,105,28,null,null,"center"); doc.line(20,35,190,35); doc.setFontSize(12); doc.text(`Valor: R$ ${item.valor.toFixed(2)}`,20,50); doc.text(`Ref: ${item.descricao}`,20,60); doc.text(`Data: ${new Date(item.data).toLocaleDateString('pt-BR',{timeZone:'UTC'})}`,20,70); doc.text(dadosEmpresa.msg||"",105,140,null,null,"center"); doc.save("recibo.pdf"); }
    window.iniciarTutorial = () => { if(window.driver){const d=window.driver.js.driver; d({showProgress:true,steps:[{popover:{title:'Bem-vindo',description:'Sistema Financeiro Pro'}},{element:'#btn-lancar',popover:{title:'Lan√ßar',description:'Registre aqui.'}}]}).drive();} }
    window.alternarStatus = async (id, statusAtual) => { try { await updateDoc(doc(db, "transacoes", id), { pago: !statusAtual }); } catch(e) { console.error(e); } }
</script>
</body>
</html>